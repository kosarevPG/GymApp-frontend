<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymApp</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-color: #ffffff;
            --text-secondary: #8e8e93;
            --accent: #0a84ff; /* –°–∏–Ω–∏–π –∫–∞–∫ –≤ iOS */
            --separator: #38383a;
            --danger: #ff453a;
            --success: #30d158;
        }

        * { 
            margin: 0;
            padding: 0;
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; 
            padding-bottom: 40px;
            touch-action: manipulation;
        }
        
        /* Navbar */
        .navbar {
            background: var(--bg-color);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--separator);
        }
        
        .navbar-left {
            width: 80px;
        }
        
        .navbar-center {
            flex: 1;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .navbar-right {
            width: 80px;
            text-align: right;
        }
        
        .btn-nav {
            background: none;
            border: none;
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            color: var(--accent);
            font-weight: 600;
        }
        
        .btn-nav:active {
            opacity: 0.6;
        }
        
        .btn-nav.hidden {
            visibility: hidden;
        }
        
        /* Container */
        .container {
            padding: 0; /* –£–±—Ä–∞–ª–∏ –æ—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã —Å–ø–∏—Å–∫–∏ –±—ã–ª–∏ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        }
        
        /* Screen */
        .screen {
            display: none;
            padding-bottom: 80px;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Search Bar */
        .search-wrapper {
            padding: 10px 16px;
            background: var(--bg-color);
            position: sticky;
            top: 45px; /* –í—ã—Å–æ—Ç–∞ –Ω–∞–≤–±–∞—Ä–∞ */
            z-index: 90;
        }
        
        .search-input {
            width: 100%;
            background: var(--card-bg);
            border: none;
            border-radius: 10px;
            padding: 10px 12px 10px 36px; /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –ø–æ–¥ –∏–∫–æ–Ω–∫—É */
            color: var(--text-color);
            font-size: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238e8e93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
        }
        
        .search-input:focus {
            outline: none;
            background-color: #2c2c2e;
        }
        
        /* List Styles (iOS style) */
        .list-container {
            display: flex;
            flex-direction: column;
            padding: 0 16px;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            border-bottom: 1px solid var(--separator);
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item:active {
            opacity: 0.6;
        }

        /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤ —Å–ø–∏—Å–∫–µ */
        .list-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            background: #333;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        /* –ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É */
        .list-img.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: #2c2c2e;
            color: #555;
        }

        .list-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .list-title {
            font-size: 17px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .list-arrow {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .groups-container {
            display: flex;
            flex-direction: column;
        }
        
        .groups-footer {
            padding: 20px 16px;
            display: flex;
            justify-content: center;
        }
        
        .btn-all {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            max-width: 200px;
        }
        
        .btn-all:active {
            opacity: 0.7;
        }
        
        /* Screen 3: Workout */
        .workout-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 12px;
            margin: 12px 16px;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–∞–π–º–µ—Ä–∞ */
        .timer-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* –¶–∏—Ñ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏ */
        .timer-display {
            font-size: 32px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--text-color);
            letter-spacing: 1px;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .timer-controls {
            display: flex;
            gap: 10px;
        }
        
        .timer-btn {
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ –°—Ç–∞—Ä—Ç/–°—Ç–æ–ø */
        .timer-btn.start {
            background-color: #2c2c2e;
            color: var(--accent);
        }
        .timer-btn.start.active {
            background-color: #2c2c2e;
            color: var(--danger);
        }
        
        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ –°–±—Ä–æ—Å */
        .timer-btn.reset {
            background-color: #2c2c2e;
            color: var(--text-secondary);
        }
        
        .set-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            margin-bottom: 8px;
            background: #000;
            border-radius: 8px;
            border: 1px solid var(--separator);
            transition: all 0.3s;
            flex-wrap: wrap;
            padding-bottom: 8px;
        }
        
        .set-row.completed {
            background: #1a2e1a;
            border-color: var(--success);
            opacity: 0.8;
        }
        
        .set-row.completed input {
            background: #0d1a0d;
            color: var(--success);
        }
        
        .set-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: var(--success);
        }
        
        .set-inputs-group {
            flex: 1;
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .set-input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .set-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--separator);
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            background: #000;
            color: var(--text-color);
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
            touch-action: manipulation;
            user-select: text;
            -webkit-user-select: text;
        }
        
        .set-input::-webkit-outer-spin-button,
        .set-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .set-input:focus {
            outline: none;
            border-color: var(--accent);
            background: #000;
        }
        
        .set-input:disabled {
            background: #0a0a0a;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .set-remove {
            background: var(--danger);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .set-remove:active {
            opacity: 0.7;
        }
        
        .set-remove.hidden {
            display: none;
        }
        
        .btn-add-set {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .btn-add-set:active {
            opacity: 0.7;
        }
        
        .input-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            margin: 0;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 20px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .history-item {
            padding: 16px;
            margin-bottom: 12px;
            background: var(--card-bg);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
        }
        
        .history-date {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .history-sets {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .history-set {
            font-size: 16px;
            color: var(--text-color);
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-group-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }
        
        .history-date-header {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            opacity: 0.8;
        }
        
        .history-sets-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .history-set-row {
            font-size: 15px;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed var(--separator);
            padding-bottom: 2px;
        }
        
        .history-set-row:last-child {
            border-bottom: none;
        }
        
        .history-rest {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—É–ø–µ—Ä—Å–µ—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-superset-card {
            background: var(--card-bg);
            border: 1px solid var(--separator);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .history-superset-header {
            background: #2c2c2e;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            border-bottom: 1px solid var(--separator);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* –ú–µ—Ç–∫–∞ "–°—É–ø–µ—Ä—Å–µ—Ç" */
        .badge-superset {
            background: var(--accent);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .history-item-row {
            padding: 8px 12px;
            border-bottom: 1px dashed var(--separator);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item-row:last-child { border-bottom: none; }
        
        .history-ex-name { font-size: 12px; color: var(--text-secondary); margin-bottom: 2px; }
        .history-ex-vals { font-size: 14px; color: var(--text-color); font-weight: 500; }
        
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –°—É–ø–µ—Ä—Å–µ—Ç–æ–≤ (–ù–æ–≤—ã–µ) --- */
        
        /* –ë–ª–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Å—É–ø–µ—Ä—Å–µ—Ç–µ */
        .exercise-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin: 16px;
            position: relative;
            border: 1px solid var(--separator);
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--separator);
        }
        
        .exercise-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-color);
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–∫—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫) */
        .btn-remove-exercise {
            background: #2c1a1a;
            color: var(--danger);
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–∞ (–º–∞–ª–µ–Ω—å–∫–∞—è, –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏) */
        .btn-add-set-small {
            width: 100%;
            padding: 10px;
            background: #2c2c2e;
            color: var(--accent);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            margin-top: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-add-set-small:active {
            background: #38383a;
        }
        
        /* –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è */
        .btn-add-exercise-global {
            width: 100%;
            padding: 14px;
            background: var(--card-bg);
            color: var(--accent);
            border: 2px dashed var(--accent);
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 16px 40px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-add-exercise-global:active {
            opacity: 0.7;
        }
        
        /* --- –ú–∏–∫—Ä–æ-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ --- */
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–¥ –∏–Ω–ø—É—Ç–∞–º–∏ */
        .stats-row {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 4px;
            margin-top: 6px;
            font-size: 11px;
            color: #999;
        }
        
        /* –ë–ª–æ–∫ 1–ü–ú */
        .stat-1rm {
            font-weight: 500;
        }
        
        /* –ë–ª–æ–∫ –î–µ–ª—å—Ç—ã (–∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞) */
        .stat-delta {
            font-weight: 700;
            opacity: 0; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            transition: opacity 0.2s;
        }
        .stat-delta.visible { opacity: 1; }
        .stat-delta.positive { color: #2e7d32; } /* –ó–µ–ª–µ–Ω—ã–π */
        .stat-delta.negative { color: #d32f2f; } /* –ö—Ä–∞—Å–Ω—ã–π */
        .stat-delta.neutral { color: #999; }     /* –°–µ—Ä—ã–π */
        
        /* –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã—Å–æ—Ç—ã —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–ª–µ–∑–∞–ª–∞ */
        .set-row {
            flex-wrap: wrap; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            padding-bottom: 8px;
        }
        .set-inputs-group {
            flex-wrap: wrap;
        }
        
        /* –ü–æ–ª–µ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ */
        .note-wrapper {
            background: #2c2c1a;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #4a4a2a;
        }
        
        .note-icon {
            font-size: 16px;
        }
        
        .note-input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
            color: var(--text-color);
            outline: none;
        }
        .note-input::placeholder {
            color: var(--text-secondary);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .error {
            background: #2c1a1a;
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 16px;
            margin: 20px;
            color: var(--danger);
            text-align: center;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.open {
            display: flex;
            animation: fadeIn 0.2s;
        }
        
        .modal-card {
            background: var(--card-bg);
            color: var(--text-color);
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 20px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-card .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-card .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-color);
        }
        
        .modal-card .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            display: flex;
            flex-direction: column;
        }
        
        .modal-img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
            object-fit: cover;
            background: #2c2c2e;
            min-height: 200px;
        }
        
        .modal-desc {
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-color);
            white-space: pre-wrap;
            margin: 0;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ Info –≤ —Å–ø–∏—Å–∫–µ */
        .info-btn {
            background: #2c2c2e;
            color: var(--accent);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 18px;
            margin-left: 10px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .info-btn:active {
            background: var(--accent);
            color: white;
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-left">
            <button class="btn-nav" id="btnBack">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <div class="navbar-center" id="navbarTitle">GymApp</div>
        <div class="navbar-right">
            <button class="btn-nav hidden" id="btnHistory">üìñ –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Screen 1: Groups -->
        <div id="screen-groups" class="screen active">
            <div id="groups-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø –º—ã—à—Ü...</div>
        </div>
        
        <!-- Screen 2: Exercises -->
        <div id="screen-exercises" class="screen">
            <div class="search-wrapper">
                <input type="text" id="searchExercises" class="search-input" 
                       placeholder="–ü–æ–∏—Å–∫" autocomplete="off" 
                       oninput="UI.filterExercises(this.value)">
            </div>
            <div id="exercises-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>
        </div>
        
        <!-- Screen 3: Workout -->
        <div id="screen-workout" class="screen">
            <div class="workout-container">
                <div class="timer-card">
                    <div class="timer-display" id="timerDisplay">00:00.00</div>
                    <div class="timer-controls">
                        <button class="timer-btn start" id="timerStartBtn">–°—Ç–∞—Ä—Ç</button>
                        <button class="timer-btn reset" id="timerResetBtn">–°–±—Ä–æ—Å</button>
                    </div>
                </div>
                <div id="sets-container"></div>
                <button class="btn-add-set" id="btnAddSet" style="display: none;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: History -->
    <div id="modalHistory" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìñ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                <button class="modal-close" id="closeHistoryBtn">√ó</button>
            </div>
            <div id="history-content" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
        </div>
    </div>
    
    <!-- Modal: Exercise Info -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modalTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                <button class="modal-close" id="closeInfoBtn">‚úï</button>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="–¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è" class="modal-img">
                <p id="modalDesc" class="modal-desc">–û–ø–∏—Å–∞–Ω–∏–µ...</p>
            </div>
        </div>
    </div>

    <!-- Modal: Add Exercise to Superset -->
    <div id="modalAddExercise" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>
                <button class="modal-close" onclick="UI.toggleModal('modalAddExercise', false)">√ó</button>
            </div>
            <div id="add-exercise-list" class="list-grid"></div>
        </div>
    </div>
    
    <script>
        // ==================== CONFIG ====================
        const CONFIG = {
            BACKEND_URL: 'https://gym-logger-bot-y602.onrender.com',
            USER_ID: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // ==================== HAPTIC FEEDBACK ====================
        const Haptic = {
            // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ –≤–∏–±—Ä–∞—Ü–∏–∏
            impact(style = 'medium') {
                try {
                    if (tg?.HapticFeedback?.impactOccurred) {
                        tg.HapticFeedback.impactOccurred(style); // 'light', 'medium', 'heavy', 'rigid', 'soft'
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –≤–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                }
            },
            
            selection() {
                try {
                    if (tg?.HapticFeedback?.selectionChanged) {
                        tg.HapticFeedback.selectionChanged();
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                }
            },
            
            notification(type = 'success') {
                try {
                    if (tg?.HapticFeedback?.notificationOccurred) {
                        tg.HapticFeedback.notificationOccurred(type); // 'error', 'success', 'warning'
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                }
            }
        };

        // ==================== API MODULE ====================
        const API = {
            async request(endpoint, params = {}, method = 'GET', body = null) {
                const url = new URL(`${CONFIG.BACKEND_URL}/api/${endpoint}`);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                
                try {
                    const opts = { method, headers: { 'Content-Type': 'application/json' } };
                    if (body) opts.body = JSON.stringify(body);
                    
                    const res = await fetch(url, opts);
                    return await res.json();
                } catch (e) {
                    console.error("API Error:", e);
                    return { error: true };
                }
            },

            getGroups: () => API.request('groups'),
            getExercises: (group) => API.request('exercises', { group }),
            getHistory: (exercise, mode = 'full', limit = 20) => API.request('history', { exercise, mode, limit }),
            saveSet: (data) => API.request('save_set', {}, 'POST', { 
                ...data, 
                user_id: CONFIG.USER_ID,
                set_group_id: App.state.sessionId // –ü–µ—Ä–µ–¥–∞–µ–º sessionId –¥–ª—è —Å—É–ø–µ—Ä—Å–µ—Ç–æ–≤
            })
        };

        // ==================== TIMER MODULE ====================
        const Timer = {
            interval: null,
            startTime: 0,
            accumulated: 0,
            running: false,
            
            formatTime(totalMilliseconds) {
                const totalSeconds = Math.floor(totalMilliseconds / 1000);
                const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const s = (totalSeconds % 60).toString().padStart(2, '0');
                const ms = Math.floor((totalMilliseconds % 1000) / 10).toString().padStart(2, '0');
                return `${m}:${s}.${ms}`;
            },
            
            render(ms) {
                const display = document.getElementById('timerDisplay');
                if (display) {
                    display.textContent = this.formatTime(ms);
                }
            },
            
            toggle() {
                const btn = document.getElementById('timerStartBtn');
                if (!btn) return;
                
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–∞–π–º–µ—Ä–∞
                
                if (this.running) {
                    this.stop();
                    btn.textContent = "–°—Ç–∞—Ä—Ç";
                    btn.classList.remove('active');
                } else {
                    this.start();
                    btn.textContent = "–°—Ç–æ–ø";
                    btn.classList.add('active');
                }
            },
            
            start() {
                this.running = true;
                this.startTime = Date.now();
                this.interval = setInterval(() => {
                    const delta = Date.now() - this.startTime;
                    this.render(this.accumulated + delta);
                }, 10);
            },
            
            stop() {
                this.running = false;
                this.accumulated += Date.now() - this.startTime;
                clearInterval(this.interval);
            },
            
            reset() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
                this.stop();
                this.accumulated = 0;
                this.render(0);
                const btn = document.getElementById('timerStartBtn');
                if (btn) {
                    btn.textContent = "–°—Ç–∞—Ä—Ç";
                    btn.classList.remove('active');
                }
            }
        };

        // ==================== APP STATE & LOGIC ====================
        const App = {
            state: {
                screen: 'groups',
                group: null,
                exercise: null,
                sets: [], // –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                activeExercises: [], // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å—É–ø–µ—Ä—Å–µ—Ç–æ–≤: [{name: "...", sets: [...]}]
                sessionId: null, // UUID —Å–µ—Å—Å–∏–∏ –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ —Å—É–ø–µ—Ä—Å–µ—Ç
                orderCounter: 0 // –°—á–µ—Ç—á–∏–∫ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–æ–≤
            },

            init() {
                // Event Listeners
                document.getElementById('btnBack').onclick = () => App.goBack();
                document.getElementById('btnHistory').onclick = () => App.loadHistory();
                document.getElementById('btnAddSet').onclick = () => App.addSetRow();
                document.getElementById('timerStartBtn').onclick = () => Timer.toggle();
                document.getElementById('timerResetBtn').onclick = () => Timer.reset();
                document.getElementById('closeHistoryBtn').onclick = () => UI.toggleModal('modalHistory', false);
                document.getElementById('closeInfoBtn').onclick = () => UI.toggleModal('infoModal', false);
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                document.getElementById('modalHistory').onclick = (e) => {
                    if (e.target.id === 'modalHistory') UI.toggleModal('modalHistory', false);
                };
                document.getElementById('infoModal').onclick = (e) => {
                    if (e.target.id === 'infoModal') UI.toggleModal('infoModal', false);
                };
                document.getElementById('modalAddExercise').onclick = (e) => {
                    if (e.target.id === 'modalAddExercise') UI.toggleModal('modalAddExercise', false);
                };

                // === –õ–û–ì–ò–ö–ê –°–ß–ï–¢–ß–ò–ö–ê –ò –°–ï–°–°–ò–ò ===
                const savedSession = localStorage.getItem('gym_session_id');
                const savedOrder = localStorage.getItem('gym_order_counter');
                const lastDate = localStorage.getItem('gym_last_date');
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "DD.MM.YYYY"
                const today = new Date().toLocaleDateString('ru-RU');

                if (lastDate !== today) {
                    // üî• –ù–û–í–´–ô –î–ï–ù–¨: –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—ë
                    console.log("–ù–æ–≤—ã–π –¥–µ–Ω—å - —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞");
                    this.state.orderCounter = 0;
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –Ω–∞ –¥–µ–Ω—å (—á—Ç–æ–±—ã —Å–≤—è–∑—ã–≤–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                    this.state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                    localStorage.setItem('gym_last_date', today);
                    localStorage.setItem('gym_session_id', this.state.sessionId);
                    localStorage.setItem('gym_order_counter', '0');
                } else {
                    // üî• –¢–û–¢ –ñ–ï –î–ï–ù–¨: –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                    this.state.orderCounter = parseInt(savedOrder) || 0;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Å–µ—Å—Å–∏–∏, –µ—Å–ª–∏ –æ–Ω –±—ã–ª (–∏–ª–∏ —Å–æ–∑–¥–∞–µ–º, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ—Ç)
                    this.state.sessionId = savedSession || ('session_' + Date.now());
                }

                this.loadGroups();
            },

            goBack() {
                if (this.state.exercise) {
                    this.state.exercise = null;
                    Timer.reset();
                    UI.showScreen('exercises');
                    UI.updateNav(this.state.group, true, false); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –Ω–∞ —ç–∫—Ä–∞–Ω–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                } else if (this.state.group) {
                    this.state.group = null;
                    UI.showScreen('groups');
                    UI.updateNav('GymApp', false);
                }
            },

            async loadGroups() {
                UI.renderLoading('groups-list');
                const res = await API.getGroups();
                if (res.groups) {
                    UI.renderGroups(res.groups);
                } else {
                    document.getElementById('groups-list').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            },

            async selectGroup(group) {
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≥—Ä—É–ø–ø—ã
                this.state.group = group;
                UI.showScreen('exercises');
                UI.updateNav(group, true, false);
                
                const list = document.getElementById('exercises-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                const res = await API.getExercises(group);
                if (res.exercises) UI.renderExercises(res.exercises);
                else list.innerHTML = '<div class="error">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
            },

            async loadAllExercises() {
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–í—Å–µ"
                this.state.group = '–í—Å–µ';
                UI.showScreen('exercises');
                UI.updateNav('–í—Å–µ', true, false);
                
                const list = document.getElementById('exercises-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>';
                
                try {
                    const groupsRes = await API.getGroups();
                    if (!groupsRes.groups || groupsRes.groups.length === 0) {
                        list.innerHTML = '<div class="error">–ù–µ—Ç –≥—Ä—É–ø–ø</div>';
                        return;
                    }
                    
                    const allExercises = [];
                    for (const group of groupsRes.groups) {
                        try {
                            const res = await API.getExercises(group);
                            if (res.exercises) allExercises.push(...res.exercises);
                        } catch (e) {
                            console.error(`–û—à–∏–±–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã ${group}:`, e);
                        }
                    }
                    
                    // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
                    const uniqueMap = new Map();
                    allExercises.forEach(ex => {
                        const name = typeof ex === 'string' ? ex : ex.name;
                        if (!uniqueMap.has(name)) {
                            uniqueMap.set(name, typeof ex === 'object' ? ex : {name: ex, desc: '', image: ''});
                        }
                    });
                    
                    const unique = Array.from(uniqueMap.values());
                    unique.sort((a, b) => {
                        const nameA = typeof a === 'string' ? a : a.name;
                        const nameB = typeof b === 'string' ? b : b.name;
                        return nameA.localeCompare(nameB, 'ru');
                    });
                    
                    if (unique.length > 0) UI.renderExercises(unique);
                    else list.innerHTML = '<div class="error">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', e);
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';
                }
            },

            async selectExercise(ex) {
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseObj = typeof ex === 'object' ? ex : {name: exerciseName, desc: '', image: ''};
                
                // ‚ùå –£–î–ê–õ–Ø–ï–ú –ì–ï–ù–ï–†–ê–¶–ò–Æ –ù–û–í–û–ô –°–ï–°–°–ò–ò (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É, —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∞ –≤ init –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å)
                // ‚ùå –£–î–ê–õ–Ø–ï–ú –°–ë–†–û–° –°–ß–ï–¢–ß–ò–ö–ê (—á—Ç–æ–±—ã –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–ª—Å—è: 5, 6, 7...)
                
                // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ sessionId –Ω–µ—Ç (–±–∞–≥), —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä–∞—Ö–æ–≤–∫—É
                if (!this.state.sessionId) {
                    this.state.sessionId = 'session_' + Date.now();
                }
                
                this.state.exercise = exerciseObj;
                UI.showScreen('workout');
                UI.updateNav(exerciseName, true, true);
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const res = await API.getHistory(exerciseName, 'last');
                
                // –†–∞–Ω—å—à–µ res.sets –±—ã–ª –º–∞—Å—Å–∏–≤–æ–º, —Ç–µ–ø–µ—Ä—å res –º–æ–∂–µ—Ç –±—ã—Ç—å {sets: [], note: ''}
                const historySets = res.sets || [];
                const lastNote = res.note || "";
                
                const initialSets = (historySets.length) 
                    ? historySets.map((s, idx) => {
                        let rest = s.rest || 0;
                        if (rest > 100) rest = rest / 60.0; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–Ω—É—Ç—ã
                        return {
                            ...s, 
                            rest, 
                            completed: false, 
                            id: Date.now() + idx + Math.random(),
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                            prevWeight: parseFloat(s.weight) || 0,
                            prevReps: parseInt(s.reps) || 0
                        };
                    })
                    : [{weight: 0, reps: 0, rest: 0, completed: false, id: Date.now(), prevWeight: 0, prevReps: 0}];
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º activeExercises —Å –ø–µ—Ä–≤—ã–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ–º
                this.state.activeExercises = [{
                    name: exerciseName,
                    exerciseObj: exerciseObj,
                    sets: initialSets,
                    note: lastNote  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–º–µ—Ç–∫—É –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                }];
                
                // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                this.state.sets = initialSets;
                
                UI.renderWorkoutScreen();
            },

            addSetRow() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥–∞
                const last = this.state.sets[this.state.sets.length - 1] || {weight: 0, reps: 0, rest: 0};
                this.state.sets.push({ ...last, completed: false, id: Date.now() + Math.random() });
                UI.renderSets(this.state.sets);
            },

            updateSetData(id, field, value) {
                const set = this.state.sets.find(s => s.id === id);
                if (set && !set.completed) {
                    const normalized = String(value).replace(',', '.');
                    if (field === 'reps') {
                        set[field] = parseInt(normalized) || 0;
                    } else {
                        set[field] = parseFloat(normalized) || 0;
                    }
                }
            },

            async toggleSet(id) {
                const idx = this.state.sets.findIndex(s => s.id === id);
                if (idx === -1) return;
                
                const set = this.state.sets[idx];
                if (set.completed) return;
                
                if (!set.weight || !set.reps) {
                    Haptic.notification('error'); // üì≥ –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã');
                    document.querySelector(`[data-id="${id}"] .set-checkbox`).checked = false;
                    return;
                }

                set.completed = true;
                UI.renderSets(this.state.sets);

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                this.state.orderCounter++;
                localStorage.setItem('gym_order_counter', this.state.orderCounter.toString());

                const res = await API.saveSet({
                    exercise: this.state.exercise.name,
                    weight: set.weight,
                    reps: set.reps,
                    rest: set.rest,
                    order: this.state.orderCounter, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
                    note: (this.state.activeExercises[0] && this.state.activeExercises[0].note) || ""  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–º–µ—Ç–∫—É –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                });

                if (res.status !== 'success') {
                    Haptic.notification('error'); // üì≥ –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
                    set.completed = false;
                    UI.renderSets(this.state.sets);
                } else {
                    Haptic.impact('medium'); // üì≥ –ü—Ä–∏—è—Ç–Ω—ã–π –ª–µ–≥–∫–∏–π —Å—Ç—É–∫ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                }
            },

            removeSet(id) {
                const idx = this.state.sets.findIndex(s => s.id === id);
                if (idx !== -1 && !this.state.sets[idx].completed) {
                    this.state.sets.splice(idx, 1);
                    UI.renderSets(this.state.sets);
                }
            },

            // ==================== SUPERSET FUNCTIONS ====================
            
            updateNote(exIndex, value) {
                if (this.state.activeExercises[exIndex]) {
                    this.state.activeExercises[exIndex].note = value;
                }
            },
            
            async toggleSetInSuperset(exIndex, setIndex) {
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (set.completed) return;
                
                if (!set.weight || !set.reps) {
                    Haptic.notification('error');
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã');
                    const checkbox = document.querySelector(`[data-ex-index="${exIndex}"][data-set-id="${set.id}"] .set-checkbox`);
                    if (checkbox) checkbox.checked = false;
                    return;
                }

                set.completed = true;
                UI.renderWorkoutScreen();

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                this.state.orderCounter++;
                localStorage.setItem('gym_order_counter', this.state.orderCounter.toString());

                const res = await API.saveSet({
                    exercise: exBlock.name,
                    weight: set.weight,
                    reps: set.reps,
                    rest: set.rest,
                    order: this.state.orderCounter, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
                    note: exBlock.note || ""  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–º–µ—Ç–∫—É
                });

                if (res.status !== 'success') {
                    Haptic.notification('error');
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
                    set.completed = false;
                    UI.renderWorkoutScreen();
                } else {
                    Haptic.impact('medium');
                }
            },

            updateSetDataInSuperset(exIndex, setIndex, field, value) {
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (set && !set.completed) {
                    const normalized = String(value).replace(',', '.');
                    if (field === 'reps') {
                        set[field] = parseInt(normalized) || 0;
                    } else {
                        set[field] = parseFloat(normalized) || 0;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (DOM-–º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è)
                    const setId = set.id;
                    
                    // 1. –û–±–Ω–æ–≤–ª—è–µ–º 1–ü–ú
                    const ormEl = document.getElementById(`orm-${setId}`);
                    if (ormEl) {
                        const oneRM = UI.calculate1RM(set.weight, set.reps);
                        ormEl.textContent = oneRM > 0 ? `üèÜ 1–ü–ú: ${oneRM}–∫–≥` : '';
                    }
                    
                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –î–µ–ª—å—Ç—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–µ–Ω—è–µ–º –≤–µ—Å)
                    if (field === 'weight') {
                        const deltaEl = document.getElementById(`delta-${setId}`);
                        if (deltaEl) {
                            const deltaObj = UI.getDelta(set.weight, set.prevWeight);
                            if (deltaObj) {
                                deltaEl.textContent = deltaObj.text;
                                deltaEl.className = `stat-delta visible ${deltaObj.class}`;
                            } else {
                                deltaEl.className = 'stat-delta'; // –°–∫—Ä—ã–≤–∞–µ–º
                            }
                        }
                    }
                }
            },

            removeSetInSuperset(exIndex, setIndex) {
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (!set.completed) {
                    exBlock.sets.splice(setIndex, 1);
                    UI.renderWorkoutScreen();
                }
            },

            addSetToExercise(exIndex) {
                Haptic.impact('light');
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock) return;
                
                const last = exBlock.sets[exBlock.sets.length - 1] || {weight: 0, reps: 0, rest: 0};
                exBlock.sets.push({ ...last, completed: false, id: Date.now() + Math.random() });
                UI.renderWorkoutScreen();
            },

            removeExerciseFromSuperset(exIndex) {
                if (exIndex === 0) return; // –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
                Haptic.impact('light');
                this.state.activeExercises.splice(exIndex, 1);
                UI.renderWorkoutScreen();
            },

            async showAddExerciseModal() {
                Haptic.impact('light');
                UI.toggleModal('modalAddExercise', true);
                const list = document.getElementById('add-exercise-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</div>';
                
                try {
                    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã –º—ã—à—Ü (—ç—Ç–æ –±—ã—Å—Ç—Ä–æ)
                    const res = await API.getGroups();
                    
                    if (!res.groups || res.groups.length === 0) {
                        list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                        return;
                    }

                    // 2. –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã
                    // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –≥—Ä—É–ø–ø—É –º—ã –±—É–¥–µ–º –∑–∞–≥—Ä—É–∂–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –í –≠–¢–û –ñ–ï –û–ö–ù–û
                    list.innerHTML = res.groups.map(group => `
                        <div class="list-item" onclick="App.loadExercisesForModal('${group}')">
                            <div style="flex-grow:1; font-weight:600;">${group}</div>
                            <div style="color:#667eea">‚Ä∫</div>
                        </div>
                    `).join('');
                    
                } catch (e) {
                    console.error(e);
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
                }
            },

            // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤–Ω—É—Ç—Ä—å –º–æ–¥–∞–ª–∫–∏
            async loadExercisesForModal(group) {
                const list = document.getElementById('add-exercise-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>';
                
                try {
                    const res = await API.getExercises(group);
                    
                    if (!res.exercises) {
                        list.innerHTML = '<div class="error">–ü—É—Å—Ç–æ</div>';
                        return;
                    }
                    
                    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–∞–º" —Å–≤–µ—Ä—Ö—É
                    const backBtn = `
                        <div class="list-item" style="background:#f0f2f5; margin-bottom:10px;" onclick="App.showAddExerciseModal()">
                            <div style="font-weight:bold; color:#666">‚Üê –ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–∞–º</div>
                        </div>
                    `;
                    
                    const exercisesHtml = res.exercises.map(ex => {
                        const name = typeof ex === 'string' ? ex : ex.name;
                        // –§–∏–ª—å—Ç—Ä—É–µ–º, –µ—Å–ª–∏ —Ç–∞–∫–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ —Å—É–ø–µ—Ä—Å–µ—Ç–µ
                        const isAdded = App.state.activeExercises.some(active => active.name === name);
                        
                        if (isAdded) return ''; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
                        
                        return `
                            <div class="list-item" onclick='App.addExerciseToSuperset(${JSON.stringify(ex)})'>
                                <div style="flex-grow:1">${name}</div>
                                <div style="color:#28a745; font-weight:bold;">+</div>
                            </div>
                        `;
                    }).join('');
                    
                    list.innerHTML = backBtn + (exercisesHtml || '<div style="padding:15px; text-align:center">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>');
                    
                } catch (e) {
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞</div>';
                }
            },

            async addExerciseToSuperset(ex) {
                Haptic.selection();
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseObj = typeof ex === 'object' ? ex : {name: exerciseName, desc: '', image: ''};
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const res = await API.getHistory(exerciseName, 'last');
                const historySets = res.sets || [];
                const lastNote = res.note || "";
                
                const initialSets = (historySets.length) 
                    ? historySets.map((s, idx) => {
                        let rest = s.rest || 0;
                        if (rest > 100) rest = rest / 60.0;
                        return {
                            ...s, 
                            rest, 
                            completed: false, 
                            id: Date.now() + idx + Math.random(),
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                            prevWeight: parseFloat(s.weight) || 0,
                            prevReps: parseInt(s.reps) || 0
                        };
                    })
                    : [{weight: 0, reps: 0, rest: 0, completed: false, id: Date.now(), prevWeight: 0, prevReps: 0}];
                
                // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Å—É–ø–µ—Ä—Å–µ—Ç
                App.state.activeExercises.push({
                    name: exerciseName,
                    exerciseObj: exerciseObj,
                    sets: initialSets,
                    note: lastNote  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–º–µ—Ç–∫—É –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                });
                
                UI.toggleModal('modalAddExercise', false);
                UI.renderWorkoutScreen();
            },

            async loadHistory() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏
                UI.toggleModal('modalHistory', true);
                const cont = document.getElementById('history-content');
                cont.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                
                // –ë–µ—Ä–µ–º –∏–º—è –ø–µ—Ä–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                const exerciseName = App.state.activeExercises.length > 0 
                    ? App.state.activeExercises[0].name 
                    : (App.state.exercise ? App.state.exercise.name : '');
                
                if (!exerciseName) {
                    cont.innerHTML = "–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ";
                    return;
                }
                
                const res = await API.getHistory(exerciseName);
                if (res.history) UI.renderHistory(res.history);
                else cont.innerHTML = "–ü—É—Å—Ç–æ";
            }
        };

        // ==================== UI RENDERER ====================
        const UI = {
            showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${id}`).classList.add('active');
                App.state.screen = id;
            },

            updateNav(title, back = false, history = false) {
                document.getElementById('navbarTitle').textContent = title;
                document.getElementById('btnBack').classList.toggle('hidden', !back);
                document.getElementById('btnHistory').classList.toggle('hidden', !history);
            },

            toggleModal(id, show) {
                const modal = document.getElementById(id);
                if (id === 'infoModal') {
                    modal.classList.toggle('open', show);
                } else {
                    modal.classList.toggle('active', show);
                }
            },

            renderLoading(id) {
                document.getElementById(id).innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            },

            // –ú–∞–ø–ø–∏–Ω–≥ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –¥–ª—è –≥—Ä—É–ø–ø
            getGroupImage(groupName) {
                const map = {
                    '–ì—Ä—É–¥—å': 'img/chest.png', 
                    '–°–ø–∏–Ω–∞': 'img/back.png',
                    '–ù–æ–≥–∏': 'img/legs.png',
                    '–ü–ª–µ—á–∏': 'img/shoulders.png',
                    '–†—É–∫–∏': 'img/arms.png',
                    '–ë–∏—Ü–µ–ø—Å': 'img/biceps.png',
                    '–¢—Ä–∏—Ü–µ–ø—Å': 'img/triceps.png',
                    '–ö–∞—Ä–¥–∏–æ': 'img/cardio.png',
                    '–ü—Ä–µ—Å—Å': 'img/abs.png'
                };
                return map[groupName] || null;
            },

            renderGroups(groups) {
                const container = document.getElementById('groups-list');
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                const order = ['–°–ø–∏–Ω–∞', '–ù–æ–≥–∏', '–ì—Ä—É–¥—å', '–ü–ª–µ—á–∏', '–ë–∏—Ü–µ–ø—Å', '–¢—Ä–∏—Ü–µ–ø—Å', '–ö–∞—Ä–¥–∏–æ', '–ü—Ä–µ—Å—Å'];
                const sortedGroups = order.filter(g => groups.includes(g))
                    .concat(groups.filter(g => !order.includes(g)));
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∫ —Å–ø–∏—Å–æ–∫ (–∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ)
                const html = sortedGroups.map(group => {
                    const imgSrc = this.getGroupImage(group);
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞ - —Å—Ç–∞–≤–∏–º img, –∏–Ω–∞—á–µ –∑–∞–≥–ª—É—à–∫—É (–ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞)
                    const imgBlock = imgSrc 
                        ? `<img src="${imgSrc}" class="list-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="list-img placeholder" style="display:none;">${group[0]}</div>`
                        : `<div class="list-img placeholder">${group[0]}</div>`;

                    return `
                        <div class="list-item" onclick="App.selectGroup('${group.replace(/'/g, "\\'")}')">
                            ${imgBlock}
                            <div class="list-content">
                                <span class="list-title">${group}</span>
                                <span class="list-arrow">‚Ä∫</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="list-container">${html}</div><div class="groups-footer"><button class="btn-all" onclick="App.loadAllExercises()">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button></div>`;
            },

            renderExercises(list) {
                const container = document.getElementById('exercises-list');
                
                if (!list || list.length === 0) {
                    container.innerHTML = '<div class="loading">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }

                const html = list.map(ex => {
                    const name = typeof ex === 'string' ? ex : ex.name;
                    // –ë–µ—Ä–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ –æ–±—ä–µ–∫—Ç–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (Image_URL –∏–∑ —Ç–∞–±–ª–∏—Ü—ã)
                    const image = (typeof ex === 'object' && ex.image) ? ex.image : null;
                    
                    const imgBlock = image 
                        ? `<img src="${image}" class="list-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="list-img placeholder" style="display:none; background:#222">üèãÔ∏è</div>`
                        : `<div class="list-img placeholder" style="background:#222">üèãÔ∏è</div>`;

                    return `
                        <div class="list-item exercise-item" data-name="${name.toLowerCase()}">
                            ${imgBlock}
                            <div class="list-content">
                                <div style="display:flex; flex-direction:column; gap:4px; flex:1;">
                                    <span class="list-title" onclick='App.selectExercise(${JSON.stringify(ex)})'>${name}</span>
                                </div>
                                <button class="info-btn" onclick='UI.showInfo(${JSON.stringify(ex)})' style="padding:10px;">
                                    ‚ÑπÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="list-container">${html}</div>`;
            },

            // –õ–æ–≥–∏–∫–∞ –ü–æ–∏—Å–∫–∞ (–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –ª–µ—Ç—É)
            filterExercises(query) {
                const q = query.toLowerCase();
                const items = document.querySelectorAll('.exercise-item');
                
                items.forEach(item => {
                    const name = item.getAttribute('data-name');
                    if (name.includes(q)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            },

            renderSets(sets) {
                // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                const container = document.getElementById('sets-container');
                container.innerHTML = sets.map((set, index) => {
                    const setId = set.id || (Date.now() + index);
                    const safeId = JSON.stringify(setId);
                    return `
                        <div class="set-row ${set.completed ? 'completed' : ''}" data-id="${setId}">
                            <input type="checkbox" class="set-checkbox" ${set.completed ? 'checked disabled' : ''} 
                                   onchange="App.toggleSet(${safeId})">
                            <div class="set-inputs-group">
                                <div class="set-input-wrapper">
                                    <div class="input-label">–í–µ—Å</div>
                                    <input type="text" inputmode="decimal" class="set-input" 
                                           value="${String(set.weight || 0).replace(',', '.')}" 
                                           oninput="const val = UI.validateFloatInput(this); App.updateSetData(${safeId}, 'weight', val)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0">
                                </div>
                                <div class="set-input-wrapper">
                                    <div class="input-label">–ü–æ–≤—Ç–æ—Ä—ã</div>
                                    <input type="text" inputmode="numeric" class="set-input" 
                                           value="${set.reps || 0}" 
                                           oninput="App.updateSetData(${safeId}, 'reps', this.value)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0">
                                </div>
                                <div class="set-input-wrapper">
                                    <div class="input-label">–û—Ç–¥—ã—Ö (–º–∏–Ω)</div>
                                    <input type="text" inputmode="decimal" class="set-input" 
                                           value="${set.rest || 0}" 
                                           oninput="const val = UI.validateFloatInput(this); App.updateSetData(${safeId}, 'rest', val)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0" step="0.5">
                                </div>
                            </div>
                            <button class="set-remove ${set.completed ? 'hidden' : ''}" 
                                    onclick="App.removeSet(${safeId})">√ó</button>
                        </div>
                    `;
                }).join('');
            },

            renderWorkoutScreen() {
                const container = document.getElementById('sets-container');
                
                // –ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–µ—Ç (–±–∞–≥), –æ—á–∏—â–∞–µ–º
                if (!App.state.activeExercises || App.state.activeExercises.length === 0) {
                    container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è</div>';
                    return;
                }
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–æ—á–∫—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                const cardsHtml = App.state.activeExercises.map((exBlock, exIndex) => {
                    const exerciseName = exBlock.name;
                    const sets = exBlock.sets || [];
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –ø–æ–¥—Ö–æ–¥–æ–≤ (–∫–∞–∫ –±—ã–ª–æ, –Ω–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
                    const setsHtml = sets.map((set, setIndex) => {
                        const setId = set.id || (Date.now() + exIndex * 1000 + setIndex);
                        const safeId = JSON.stringify(setId); // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                        
                        // –°—á–∏—Ç–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                        const oneRM = UI.calculate1RM(set.weight, set.reps);
                        const deltaObj = UI.getDelta(set.weight, set.prevWeight);
                        
                        let deltaHtml = '';
                        if (deltaObj) {
                            deltaHtml = `<span class="stat-delta visible ${deltaObj.class}" id="delta-${setId}">${deltaObj.text}</span>`;
                        } else {
                            deltaHtml = `<span class="stat-delta" id="delta-${setId}"></span>`;
                        }

                        const ormHtml = `<span class="stat-1rm" id="orm-${setId}">${oneRM > 0 ? 'üèÜ 1–ü–ú: ' + oneRM + '–∫–≥' : ''}</span>`;
                        
                        return `
                            <div class="set-row ${set.completed ? 'completed' : ''}" data-ex-index="${exIndex}" data-set-id="${setId}">
                                <input type="checkbox" class="set-checkbox" ${set.completed ? 'checked disabled' : ''} 
                                       onchange="App.toggleSetInSuperset(${exIndex}, ${setIndex})">
                                
                                <div style="flex: 1; width: 100%;">
                                    <div class="set-inputs-group">
                                        <div class="set-input-wrapper">
                                            <div class="input-label">–í–µ—Å</div>
                                            <input type="text" inputmode="decimal" class="set-input" 
                                                   value="${String(set.weight || 0).replace(',', '.')}" 
                                                   oninput="const val = UI.validateFloatInput(this); App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'weight', val)"
                                                   onfocus="this.select()"
                                                   ${set.completed ? 'disabled' : ''} placeholder="0">
                                        </div>
                                        <div class="set-input-wrapper">
                                            <div class="input-label">–ü–æ–≤—Ç</div>
                                            <input type="tel" inputmode="numeric" class="set-input" 
                                                   value="${set.reps || 0}" 
                                                   oninput="App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'reps', this.value)"
                                                   onfocus="this.select()"
                                                   ${set.completed ? 'disabled' : ''} placeholder="0">
                                        </div>
                                        <div class="set-input-wrapper">
                                            <div class="input-label">–û—Ç–¥(–º)</div>
                                            <input type="text" inputmode="decimal" class="set-input" 
                                                   value="${set.rest || 0}" 
                                                   oninput="const val = UI.validateFloatInput(this); App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'rest', val)"
                                                   onfocus="this.select()"
                                                   ${set.completed ? 'disabled' : ''} placeholder="0" step="0.5">
                                        </div>
                                    </div>
                                    
                                    <div class="stats-row">
                                        ${ormHtml}
                                        ${deltaHtml}
                                    </div>
                                </div>
                                
                                <button class="set-remove ${set.completed ? 'hidden' : ''}" 
                                        onclick="App.removeSetInSuperset(${exIndex}, ${setIndex})">√ó</button>
                            </div>
                        `;
                    }).join('');
                    
                    // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                    const currentNote = exBlock.note || '';
                    
                    // HTML –∑–∞–º–µ—Ç–∫–∏
                    const noteHtml = `
                        <div class="note-wrapper">
                            <span class="note-icon">üìù</span>
                            <input type="text" class="note-input" 
                                placeholder="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–Ω–∞–ø—Ä. –°–∏–¥–µ–Ω—å–µ 4)" 
                                value="${currentNote.replace(/"/g, '&quot;')}"
                                oninput="App.updateNote(${exIndex}, this.value)">
                        </div>
                    `;
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ü–µ–ª–∏–∫–æ–º
                    return `
                        <div class="exercise-card">
                            <div class="exercise-header">
                                <span class="exercise-title">${exIndex + 1}. ${exerciseName}</span>
                                ${exIndex > 0 ? `<button class="btn-remove-exercise" onclick="App.removeExerciseFromSuperset(${exIndex})">√ó</button>` : ''}
                            </div>
                            
                            ${noteHtml}
                            
                            <div class="exercise-sets">
                                ${setsHtml}
                            </div>
                            
                            <button class="btn-add-set-small" onclick="App.addSetToExercise(${exIndex})">
                                + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥
                            </button>
                        </div>
                    `;
                }).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" –≤ —Å–∞–º–æ–º –Ω–∏–∑—É
                const addExerciseBtn = `
                    <button class="btn-add-exercise-global" onclick="App.showAddExerciseModal()">
                        <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Å–µ—Ç
                    </button>
                `;
                
                container.innerHTML = cardsHtml + addExerciseBtn;
            },

            renderHistory(historyData) {
                const container = document.getElementById('history-content');
                container.innerHTML = '';
                
                if (!historyData || historyData.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                    return;
                }
                
                // 1. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –î–ê–¢–ï
                const byDate = {};
                historyData.forEach(item => {
                    let dateKey = String(item.date || '').split(',')[0].trim();
                    if (!dateKey) return;
                    
                    if (!byDate[dateKey]) byDate[dateKey] = {};
                    
                    // 2. –í–Ω—É—Ç—Ä–∏ –¥–∞—Ç—ã –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ set_group_id
                    const groupId = item.set_group_id || 'unknown_' + Math.random();
                    if (!byDate[dateKey][groupId]) byDate[dateKey][groupId] = [];
                    byDate[dateKey][groupId].push(item);
                });
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞—Ç
                const sortedDates = Object.keys(byDate).sort((a, b) => {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 23.11.2025 –≤ 2025-11-23 –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    const toISO = (d) => d.split('.').reverse().join('-');
                    return toISO(b).localeCompare(toISO(a));
                });
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
                let fullHtml = '';
                
                sortedDates.forEach(date => {
                    fullHtml += `<div class="history-date-header">üìÖ ${date}</div>`;
                    
                    const groupsInDate = byDate[date];
                    Object.values(groupsInDate).forEach(groupItems => {
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å—É–ø–µ—Ä—Å–µ—Ç —ç—Ç–æ –∏–ª–∏ –æ–±—ã—á–Ω—ã–π —Å–µ—Ç
                        // (–µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–µ –µ—Å—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏)
                        const uniqueNames = [...new Set(groupItems.map(i => i.exercise))];
                        const isSuperset = uniqueNames.length > 1;
                        
                        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
                        let headerHtml = '';
                        if (isSuperset) {
                            headerHtml = `
                                <div class="history-superset-header">
                                    <span class="badge-superset">–°—É–ø–µ—Ä—Å–µ—Ç</span>
                                    <span>${uniqueNames.join(' + ')}</span>
                                </div>
                            `;
                        }
                        
                        // –°–ø–∏—Å–æ–∫ –ø–æ–¥—Ö–æ–¥–æ–≤
                        const rowsHtml = groupItems.map(item => {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Å—É–ø–µ—Ä—Å–µ—Ç
                            const nameBlock = isSuperset 
                                ? `<div class="history-ex-name">${item.exercise}</div>` 
                                : '';
                            
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–¥—ã—Ö
                            let restDisplay = '';
                            if (item.rest) {
                                let restMinutes = item.rest;
                                if (restMinutes > 100) restMinutes = restMinutes / 60.0;
                                if (restMinutes % 1 === 0) {
                                    restDisplay = `${restMinutes}–º`;
                                } else {
                                    restDisplay = `${restMinutes.toFixed(1)}–º`;
                                }
                            }
                                
                            return `
                                <div class="history-item-row">
                                    <div>
                                        ${nameBlock}
                                        <div class="history-ex-vals">
                                            ${item.weight} –∫–≥ √ó ${item.reps}
                                        </div>
                                    </div>
                                    <div style="color:#aaa; font-size:12px;">
                                        ${restDisplay}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        fullHtml += `
                            <div class="history-superset-card">
                                ${headerHtml}
                                ${rowsHtml}
                            </div>
                        `;
                    });
                });
                
                container.innerHTML = fullHtml;
            },

            showInfo(ex) {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseDesc = typeof ex === 'object' ? (ex.desc || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') : '';
                const exerciseImage = typeof ex === 'object' ? (ex.image || '') : '';
                
                document.getElementById('modalTitle').textContent = exerciseName;
                const descEl = document.getElementById('modalDesc');
                descEl.textContent = (exerciseDesc && exerciseDesc !== 'undefined' && exerciseDesc !== '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') 
                    ? exerciseDesc 
                    : '–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.';
                
                const imgEl = document.getElementById('modalImage');
                if (exerciseImage && exerciseImage !== 'undefined' && exerciseImage !== '') {
                    imgEl.src = exerciseImage;
                    imgEl.style.display = 'block';
                } else {
                    imgEl.style.display = 'none';
                }
                
                this.toggleModal('infoModal', true);
            },

            // === –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –º–∏–∫—Ä–æ-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ ===
            calculate1RM(weight, reps) {
                const w = parseFloat(weight) || 0;
                const r = parseInt(reps) || 0;
                if (w === 0 || r === 0) return 0;
                if (r === 1) return w;
                // –§–æ—Ä–º—É–ª–∞ –≠–ø–ª–∏: Weight * (1 + Reps/30)
                return Math.round(w * (1 + r / 30));
            },

            getDelta(current, prev) {
                const curVal = parseFloat(current) || 0;
                const prevVal = parseFloat(prev) || 0;
                
                if (prevVal === 0) return null; // –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ - –Ω–µ—Ç –¥–µ–ª—å—Ç—ã
                
                const diff = curVal - prevVal;
                // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1 –∑–Ω–∞–∫–∞, –µ—Å–ª–∏ –¥—Ä–æ–±–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä 2.5), –∏–Ω–∞—á–µ —Ü–µ–ª–æ–µ
                const diffStr = Number.isInteger(diff) ? diff : diff.toFixed(1);
                
                if (diff > 0) return { text: `+${diffStr} –∫–≥`, class: 'positive' };
                if (diff < 0) return { text: `${diffStr} –∫–≥`, class: 'negative' };
                return { text: '0', class: 'neutral' };
            },

            validateFloatInput(input) {
                let val = input.value.replace(/[^0-9.,]/g, '');
                val = val.replace(',', '.');
                const parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join('');
                }
                if (input.value !== val) {
                    input.value = val;
                }
                return val;
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å HTML)
        function goBack() { App.goBack(); }
        function showHistory() { App.loadHistory(); }
        function closeHistory() { UI.toggleModal('modalHistory', false); }
        function openInfoModal(title, desc, image) { UI.showInfo({name: title, desc, image}); }
        function closeInfoModal(event) {
            if (event === null || event.target.id === 'infoModal') {
                UI.toggleModal('infoModal', false);
            }
        }
        function toggleTimer() { Timer.toggle(); }
        function resetTimer() { Timer.reset(); }
        function addSet() { App.addSetRow(); }

        // Start
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
