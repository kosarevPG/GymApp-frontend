<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymApp</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        /* Navbar */
        .navbar {
            background: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-left {
            width: 80px;
        }
        
        .navbar-center {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .navbar-right {
            width: 80px;
            text-align: right;
        }
        
        .btn-nav {
            background: none;
            border: none;
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
        }
        
        .btn-nav:active {
            opacity: 0.7;
        }
        
        .btn-nav.hidden {
            visibility: hidden;
        }
        
        /* Container */
        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Screen */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* Screen 1 & 2: Groups and Exercises */
        .list-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .groups-container {
            display: flex;
            flex-direction: column;
        }
        
        .groups-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .group-pair-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .group-pair-item {
            background: white;
            padding: 12px 16px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .group-pair-item:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            background: #f5f5f5;
        }
        
        .group-pair-item h3 {
            font-size: 15px;
            font-weight: 500;
            color: #333;
            margin: 0;
        }
        
        .groups-footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .btn-all {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 200px;
        }
        
        .btn-all:active {
            background: #5568d3;
            transform: scale(0.98);
        }
        
        .list-item {
            background: white;
            padding: 12px 16px;
            border-radius: 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .list-item:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            background: #f5f5f5;
        }
        
        .list-item h3 {
            font-size: 15px;
            font-weight: 500;
            color: #333;
            margin: 0;
        }
        
        /* Screen 3: Workout */
        .workout-container {
            background: white;
            border-radius: 16px;
            padding: 12px;
            margin-top: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–∞–π–º–µ—Ä–∞ */
        .timer-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* –¶–∏—Ñ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏ */
        .timer-display {
            font-size: 32px;
            font-weight: 700;
            font-variant-numeric: tabular-nums; /* –ß—Ç–æ–±—ã —Ü–∏—Ñ—Ä—ã –Ω–µ —Å–∫–∞–∫–∞–ª–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ */
            color: #333;
            letter-spacing: 1px;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .timer-controls {
            display: flex;
            gap: 10px;
        }
        
        .timer-btn {
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ –°—Ç–∞—Ä—Ç/–°—Ç–æ–ø */
        .timer-btn.start {
            background-color: #eef2ff;
            color: #667eea;
        }
        .timer-btn.start.active { /* –ö–æ–≥–¥–∞ —Ç–∞–π–º–µ—Ä –∏–¥–µ—Ç */
            background-color: #ffebee;
            color: #ef5350;
        }
        
        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ –°–±—Ä–æ—Å */
        .timer-btn.reset {
            background-color: #f5f5f5;
            color: #888;
        }
        
        .set-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .set-row.completed {
            background: #e8f5e9;
            border-color: #4caf50;
            opacity: 0.8;
        }
        
        .set-row.completed input {
            background: #c8e6c9;
            color: #2e7d32;
        }
        
        .set-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .set-inputs-group {
            flex: 1;
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .set-input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .set-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            background: white;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
            touch-action: manipulation;
            user-select: text;
            -webkit-user-select: text;
        }
        
        .set-input::-webkit-outer-spin-button,
        .set-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .set-input:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
        }
        
        .set-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .set-remove {
            background: #ff5252;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .set-remove:active {
            background: #d32f2f;
        }
        
        .set-remove.hidden {
            display: none;
        }
        
        .btn-add-set {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .btn-add-set:active {
            background: #5568d3;
        }
        
        .input-label {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin: 0;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .history-item {
            padding: 16px;
            margin-bottom: 12px;
            background: #f9f9f9;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .history-date {
            font-size: 14px;
            color: #999;
            margin-bottom: 8px;
        }
        
        .history-sets {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .history-set {
            font-size: 16px;
            color: #333;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-group-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea; /* –¶–≤–µ—Ç–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç —Å–ª–µ–≤–∞ */
        }
        
        .history-date-header {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            opacity: 0.8;
        }
        
        .history-sets-list {
            display: flex;
            flex-direction: column;
            gap: 4px; /* –ú–∞–ª–µ–Ω—å–∫–∏–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –ø–æ–¥—Ö–æ–¥–∞–º–∏ */
        }
        
        .history-set-row {
            font-size: 15px;
            color: #444;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #e0e0e0;
            padding-bottom: 2px;
        }
        
        .history-set-row:last-child {
            border-bottom: none;
        }
        
        .history-rest {
            font-size: 12px;
            color: #888;
            margin-left: 8px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—É–ø–µ—Ä—Å–µ—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-superset-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        
        .history-superset-header {
            background: #f8f9fa;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* –ú–µ—Ç–∫–∞ "–°—É–ø–µ—Ä—Å–µ—Ç" */
        .badge-superset {
            background: #667eea;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .history-item-row {
            padding: 8px 12px;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item-row:last-child { border-bottom: none; }
        
        .history-ex-name { font-size: 12px; color: #888; margin-bottom: 2px; }
        .history-ex-vals { font-size: 14px; color: #333; font-weight: 500; }
        
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –°—É–ø–µ—Ä—Å–µ—Ç–æ–≤ (–ù–æ–≤—ã–µ) --- */
        
        /* –ë–ª–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Å—É–ø–µ—Ä—Å–µ—Ç–µ */
        .exercise-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            position: relative;
            border: 1px solid #f0f0f0;
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .exercise-title {
            font-size: 17px;
            font-weight: 700;
            color: #333;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–∫—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫) */
        .btn-remove-exercise {
            background: #fff0f0;
            color: #ff3b30;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–∞ (–º–∞–ª–µ–Ω—å–∫–∞—è, –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏) */
        .btn-add-set-small {
            width: 100%;
            padding: 10px;
            background: #f0f2f5;
            color: #667eea;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            margin-top: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-add-set-small:active {
            background: #e4e6eb;
        }
        
        /* –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è */
        .btn-add-exercise-global {
            width: 100%;
            padding: 14px;
            background: white;
            color: #667eea;
            border: 2px dashed #667eea; /* –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ */
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 40px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-add-exercise-global:active {
            background: #f8f9fa;
            opacity: 0.8;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 16px;
        }
        
        .error {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 16px;
            margin: 20px;
            color: #c62828;
            text-align: center;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ */
        .modal-overlay {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px); /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ (iOS style) */
        }
        
        .modal-overlay.open {
            display: flex;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-card {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-card .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-card .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }
        
        .modal-card .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #888;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            display: flex;
            flex-direction: column;
        }
        
        .modal-img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
            object-fit: cover;
            background: #f0f0f0;
            min-height: 200px;
        }
        
        .modal-desc {
            font-size: 15px;
            line-height: 1.5;
            color: #444;
            white-space: pre-wrap; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–±–∑–∞—Ü—ã */
            margin: 0;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ Info –≤ —Å–ø–∏—Å–∫–µ */
        .info-btn {
            background: #eef2ff;
            color: #667eea;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 18px;
            margin-left: 10px;
            cursor: pointer;
            flex-shrink: 0; /* –ß—Ç–æ–±—ã –Ω–µ —Å–∂–∏–º–∞–ª–∞—Å—å */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .info-btn:active {
            background: #667eea;
            color: white;
            transform: scale(0.95);
        }
        
        .list-item {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-left">
            <button class="btn-nav" id="btnBack">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <div class="navbar-center" id="navbarTitle">GymApp</div>
        <div class="navbar-right">
            <button class="btn-nav hidden" id="btnHistory">üìñ –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Screen 1: Groups -->
        <div id="screen-groups" class="screen active">
            <div id="groups-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø –º—ã—à—Ü...</div>
        </div>
        
        <!-- Screen 2: Exercises -->
        <div id="screen-exercises" class="screen">
            <div id="exercises-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>
        </div>
        
        <!-- Screen 3: Workout -->
        <div id="screen-workout" class="screen">
            <div class="workout-container">
                <div class="timer-card">
                    <div class="timer-display" id="timerDisplay">00:00.00</div>
                    <div class="timer-controls">
                        <button class="timer-btn start" id="timerStartBtn">–°—Ç–∞—Ä—Ç</button>
                        <button class="timer-btn reset" id="timerResetBtn">–°–±—Ä–æ—Å</button>
                    </div>
                </div>
                <div id="sets-container"></div>
                <button class="btn-add-set" id="btnAddSet" style="display: none;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: History -->
    <div id="modalHistory" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìñ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                <button class="modal-close" id="closeHistoryBtn">√ó</button>
            </div>
            <div id="history-content" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
        </div>
    </div>
    
    <!-- Modal: Exercise Info -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modalTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                <button class="modal-close" id="closeInfoBtn">‚úï</button>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="–¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è" class="modal-img">
                <p id="modalDesc" class="modal-desc">–û–ø–∏—Å–∞–Ω–∏–µ...</p>
            </div>
        </div>
    </div>

    <!-- Modal: Add Exercise to Superset -->
    <div id="modalAddExercise" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>
                <button class="modal-close" onclick="UI.toggleModal('modalAddExercise', false)">√ó</button>
            </div>
            <div id="add-exercise-list" class="list-grid"></div>
        </div>
    </div>
    
    <script>
        // ==================== CONFIG ====================
        const CONFIG = {
            BACKEND_URL: 'https://gym-logger-bot-y602.onrender.com',
            USER_ID: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // ==================== HAPTIC FEEDBACK ====================
        const Haptic = {
            // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ –≤–∏–±—Ä–∞—Ü–∏–∏
            impact(style = 'medium') {
                try {
                    if (tg?.HapticFeedback?.impactOccurred) {
                        tg.HapticFeedback.impactOccurred(style); // 'light', 'medium', 'heavy', 'rigid', 'soft'
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –≤–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                }
            },
            
            selection() {
                try {
                    if (tg?.HapticFeedback?.selectionChanged) {
                        tg.HapticFeedback.selectionChanged();
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                }
            },
            
            notification(type = 'success') {
                try {
                    if (tg?.HapticFeedback?.notificationOccurred) {
                        tg.HapticFeedback.notificationOccurred(type); // 'error', 'success', 'warning'
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                }
            }
        };

        // ==================== API MODULE ====================
        const API = {
            async request(endpoint, params = {}, method = 'GET', body = null) {
                const url = new URL(`${CONFIG.BACKEND_URL}/api/${endpoint}`);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                
                try {
                    const opts = { method, headers: { 'Content-Type': 'application/json' } };
                    if (body) opts.body = JSON.stringify(body);
                    
                    const res = await fetch(url, opts);
                    return await res.json();
                } catch (e) {
                    console.error("API Error:", e);
                    return { error: true };
                }
            },

            getGroups: () => API.request('groups'),
            getExercises: (group) => API.request('exercises', { group }),
            getHistory: (exercise, mode = 'full', limit = 20) => API.request('history', { exercise, mode, limit }),
            saveSet: (data) => API.request('save_set', {}, 'POST', { 
                ...data, 
                user_id: CONFIG.USER_ID,
                set_group_id: App.state.sessionId // –ü–µ—Ä–µ–¥–∞–µ–º sessionId –¥–ª—è —Å—É–ø–µ—Ä—Å–µ—Ç–æ–≤
            })
        };

        // ==================== TIMER MODULE ====================
        const Timer = {
            interval: null,
            startTime: 0,
            accumulated: 0,
            running: false,
            
            formatTime(totalMilliseconds) {
                const totalSeconds = Math.floor(totalMilliseconds / 1000);
                const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const s = (totalSeconds % 60).toString().padStart(2, '0');
                const ms = Math.floor((totalMilliseconds % 1000) / 10).toString().padStart(2, '0');
                return `${m}:${s}.${ms}`;
            },
            
            render(ms) {
                const display = document.getElementById('timerDisplay');
                if (display) {
                    display.textContent = this.formatTime(ms);
                }
            },
            
            toggle() {
                const btn = document.getElementById('timerStartBtn');
                if (!btn) return;
                
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–∞–π–º–µ—Ä–∞
                
                if (this.running) {
                    this.stop();
                    btn.textContent = "–°—Ç–∞—Ä—Ç";
                    btn.classList.remove('active');
                } else {
                    this.start();
                    btn.textContent = "–°—Ç–æ–ø";
                    btn.classList.add('active');
                }
            },
            
            start() {
                this.running = true;
                this.startTime = Date.now();
                this.interval = setInterval(() => {
                    const delta = Date.now() - this.startTime;
                    this.render(this.accumulated + delta);
                }, 10);
            },
            
            stop() {
                this.running = false;
                this.accumulated += Date.now() - this.startTime;
                clearInterval(this.interval);
            },
            
            reset() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
                this.stop();
                this.accumulated = 0;
                this.render(0);
                const btn = document.getElementById('timerStartBtn');
                if (btn) {
                    btn.textContent = "–°—Ç–∞—Ä—Ç";
                    btn.classList.remove('active');
                }
            }
        };

        // ==================== APP STATE & LOGIC ====================
        const App = {
            state: {
                screen: 'groups',
                group: null,
                exercise: null,
                sets: [], // –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                activeExercises: [], // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å—É–ø–µ—Ä—Å–µ—Ç–æ–≤: [{name: "...", sets: [...]}]
                sessionId: null // UUID —Å–µ—Å—Å–∏–∏ –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ —Å—É–ø–µ—Ä—Å–µ—Ç
            },

            init() {
                // Event Listeners
                document.getElementById('btnBack').onclick = () => App.goBack();
                document.getElementById('btnHistory').onclick = () => App.loadHistory();
                document.getElementById('btnAddSet').onclick = () => App.addSetRow();
                document.getElementById('timerStartBtn').onclick = () => Timer.toggle();
                document.getElementById('timerResetBtn').onclick = () => Timer.reset();
                document.getElementById('closeHistoryBtn').onclick = () => UI.toggleModal('modalHistory', false);
                document.getElementById('closeInfoBtn').onclick = () => UI.toggleModal('infoModal', false);
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                document.getElementById('modalHistory').onclick = (e) => {
                    if (e.target.id === 'modalHistory') UI.toggleModal('modalHistory', false);
                };
                document.getElementById('infoModal').onclick = (e) => {
                    if (e.target.id === 'infoModal') UI.toggleModal('infoModal', false);
                };
                document.getElementById('modalAddExercise').onclick = (e) => {
                    if (e.target.id === 'modalAddExercise') UI.toggleModal('modalAddExercise', false);
                };

                this.loadGroups();
            },

            goBack() {
                if (this.state.exercise) {
                    this.state.exercise = null;
                    Timer.reset();
                    UI.showScreen('exercises');
                    UI.updateNav(this.state.group);
                } else if (this.state.group) {
                    this.state.group = null;
                    UI.showScreen('groups');
                    UI.updateNav('GymApp', false);
                }
            },

            async loadGroups() {
                UI.renderLoading('groups-list');
                const res = await API.getGroups();
                if (res.groups) {
                    UI.renderGroups(res.groups);
                } else {
                    document.getElementById('groups-list').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            },

            async selectGroup(group) {
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≥—Ä—É–ø–ø—ã
                this.state.group = group;
                UI.showScreen('exercises');
                UI.updateNav(group, true, false);
                
                const list = document.getElementById('exercises-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                const res = await API.getExercises(group);
                if (res.exercises) UI.renderExercises(res.exercises);
                else list.innerHTML = '<div class="error">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
            },

            async loadAllExercises() {
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–í—Å–µ"
                this.state.group = '–í—Å–µ';
                UI.showScreen('exercises');
                UI.updateNav('–í—Å–µ', true, false);
                
                const list = document.getElementById('exercises-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>';
                
                try {
                    const groupsRes = await API.getGroups();
                    if (!groupsRes.groups || groupsRes.groups.length === 0) {
                        list.innerHTML = '<div class="error">–ù–µ—Ç –≥—Ä—É–ø–ø</div>';
                        return;
                    }
                    
                    const allExercises = [];
                    for (const group of groupsRes.groups) {
                        try {
                            const res = await API.getExercises(group);
                            if (res.exercises) allExercises.push(...res.exercises);
                        } catch (e) {
                            console.error(`–û—à–∏–±–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã ${group}:`, e);
                        }
                    }
                    
                    // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
                    const uniqueMap = new Map();
                    allExercises.forEach(ex => {
                        const name = typeof ex === 'string' ? ex : ex.name;
                        if (!uniqueMap.has(name)) {
                            uniqueMap.set(name, typeof ex === 'object' ? ex : {name: ex, desc: '', image: ''});
                        }
                    });
                    
                    const unique = Array.from(uniqueMap.values());
                    unique.sort((a, b) => {
                        const nameA = typeof a === 'string' ? a : a.name;
                        const nameB = typeof b === 'string' ? b : b.name;
                        return nameA.localeCompare(nameB, 'ru');
                    });
                    
                    if (unique.length > 0) UI.renderExercises(unique);
                    else list.innerHTML = '<div class="error">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', e);
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';
                }
            },

            async selectExercise(ex) {
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseObj = typeof ex === 'object' ? ex : {name: exerciseName, desc: '', image: ''};
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π sessionId –¥–ª—è –Ω–æ–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                this.state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                this.state.exercise = exerciseObj;
                UI.showScreen('workout');
                UI.updateNav(exerciseName, true, true);
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const res = await API.getHistory(exerciseName, 'last');
                const initialSets = (res.sets && res.sets.length) 
                    ? res.sets.map((s, idx) => {
                        let rest = s.rest || 0;
                        if (rest > 100) rest = rest / 60.0; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–Ω—É—Ç—ã
                        return {...s, rest, completed: false, id: Date.now() + idx + Math.random()};
                    })
                    : [{weight: 0, reps: 0, rest: 0, completed: false, id: Date.now()}];
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º activeExercises —Å –ø–µ—Ä–≤—ã–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ–º
                this.state.activeExercises = [{
                    name: exerciseName,
                    exerciseObj: exerciseObj,
                    sets: initialSets
                }];
                
                // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                this.state.sets = initialSets;
                
                UI.renderWorkoutScreen();
            },

            addSetRow() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥–∞
                const last = this.state.sets[this.state.sets.length - 1] || {weight: 0, reps: 0, rest: 0};
                this.state.sets.push({ ...last, completed: false, id: Date.now() + Math.random() });
                UI.renderSets(this.state.sets);
            },

            updateSetData(id, field, value) {
                const set = this.state.sets.find(s => s.id === id);
                if (set && !set.completed) {
                    const normalized = String(value).replace(',', '.');
                    if (field === 'reps') {
                        set[field] = parseInt(normalized) || 0;
                    } else {
                        set[field] = parseFloat(normalized) || 0;
                    }
                }
            },

            async toggleSet(id) {
                const idx = this.state.sets.findIndex(s => s.id === id);
                if (idx === -1) return;
                
                const set = this.state.sets[idx];
                if (set.completed) return;
                
                if (!set.weight || !set.reps) {
                    Haptic.notification('error'); // üì≥ –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã');
                    document.querySelector(`[data-id="${id}"] .set-checkbox`).checked = false;
                    return;
                }

                set.completed = true;
                UI.renderSets(this.state.sets);

                const res = await API.saveSet({
                    exercise: this.state.exercise.name,
                    weight: set.weight,
                    reps: set.reps,
                    rest: set.rest
                });

                if (res.status !== 'success') {
                    Haptic.notification('error'); // üì≥ –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
                    set.completed = false;
                    UI.renderSets(this.state.sets);
                } else {
                    Haptic.impact('medium'); // üì≥ –ü—Ä–∏—è—Ç–Ω—ã–π –ª–µ–≥–∫–∏–π —Å—Ç—É–∫ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                }
            },

            removeSet(id) {
                const idx = this.state.sets.findIndex(s => s.id === id);
                if (idx !== -1 && !this.state.sets[idx].completed) {
                    this.state.sets.splice(idx, 1);
                    UI.renderSets(this.state.sets);
                }
            },

            // ==================== SUPERSET FUNCTIONS ====================
            
            async toggleSetInSuperset(exIndex, setIndex) {
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (set.completed) return;
                
                if (!set.weight || !set.reps) {
                    Haptic.notification('error');
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã');
                    const checkbox = document.querySelector(`[data-ex-index="${exIndex}"][data-set-id="${set.id}"] .set-checkbox`);
                    if (checkbox) checkbox.checked = false;
                    return;
                }

                set.completed = true;
                UI.renderWorkoutScreen();

                const res = await API.saveSet({
                    exercise: exBlock.name,
                    weight: set.weight,
                    reps: set.reps,
                    rest: set.rest
                });

                if (res.status !== 'success') {
                    Haptic.notification('error');
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
                    set.completed = false;
                    UI.renderWorkoutScreen();
                } else {
                    Haptic.impact('medium');
                }
            },

            updateSetDataInSuperset(exIndex, setIndex, field, value) {
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (set && !set.completed) {
                    const normalized = String(value).replace(',', '.');
                    if (field === 'reps') {
                        set[field] = parseInt(normalized) || 0;
                    } else {
                        set[field] = parseFloat(normalized) || 0;
                    }
                }
            },

            removeSetInSuperset(exIndex, setIndex) {
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (!set.completed) {
                    exBlock.sets.splice(setIndex, 1);
                    UI.renderWorkoutScreen();
                }
            },

            addSetToExercise(exIndex) {
                Haptic.impact('light');
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock) return;
                
                const last = exBlock.sets[exBlock.sets.length - 1] || {weight: 0, reps: 0, rest: 0};
                exBlock.sets.push({ ...last, completed: false, id: Date.now() + Math.random() });
                UI.renderWorkoutScreen();
            },

            removeExerciseFromSuperset(exIndex) {
                if (exIndex === 0) return; // –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
                Haptic.impact('light');
                this.state.activeExercises.splice(exIndex, 1);
                UI.renderWorkoutScreen();
            },

            async showAddExerciseModal() {
                Haptic.impact('light');
                UI.toggleModal('modalAddExercise', true);
                const list = document.getElementById('add-exercise-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</div>';
                
                try {
                    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã –º—ã—à—Ü (—ç—Ç–æ –±—ã—Å—Ç—Ä–æ)
                    const res = await API.getGroups();
                    
                    if (!res.groups || res.groups.length === 0) {
                        list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                        return;
                    }

                    // 2. –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã
                    // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –≥—Ä—É–ø–ø—É –º—ã –±—É–¥–µ–º –∑–∞–≥—Ä—É–∂–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –í –≠–¢–û –ñ–ï –û–ö–ù–û
                    list.innerHTML = res.groups.map(group => `
                        <div class="list-item" onclick="App.loadExercisesForModal('${group}')">
                            <div style="flex-grow:1; font-weight:600;">${group}</div>
                            <div style="color:#667eea">‚Ä∫</div>
                        </div>
                    `).join('');
                    
                } catch (e) {
                    console.error(e);
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
                }
            },

            // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤–Ω—É—Ç—Ä—å –º–æ–¥–∞–ª–∫–∏
            async loadExercisesForModal(group) {
                const list = document.getElementById('add-exercise-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>';
                
                try {
                    const res = await API.getExercises(group);
                    
                    if (!res.exercises) {
                        list.innerHTML = '<div class="error">–ü—É—Å—Ç–æ</div>';
                        return;
                    }
                    
                    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–∞–º" —Å–≤–µ—Ä—Ö—É
                    const backBtn = `
                        <div class="list-item" style="background:#f0f2f5; margin-bottom:10px;" onclick="App.showAddExerciseModal()">
                            <div style="font-weight:bold; color:#666">‚Üê –ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–∞–º</div>
                        </div>
                    `;
                    
                    const exercisesHtml = res.exercises.map(ex => {
                        const name = typeof ex === 'string' ? ex : ex.name;
                        // –§–∏–ª—å—Ç—Ä—É–µ–º, –µ—Å–ª–∏ —Ç–∞–∫–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ —Å—É–ø–µ—Ä—Å–µ—Ç–µ
                        const isAdded = App.state.activeExercises.some(active => active.name === name);
                        
                        if (isAdded) return ''; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
                        
                        return `
                            <div class="list-item" onclick='App.addExerciseToSuperset(${JSON.stringify(ex)})'>
                                <div style="flex-grow:1">${name}</div>
                                <div style="color:#28a745; font-weight:bold;">+</div>
                            </div>
                        `;
                    }).join('');
                    
                    list.innerHTML = backBtn + (exercisesHtml || '<div style="padding:15px; text-align:center">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>');
                    
                } catch (e) {
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞</div>';
                }
            },

            async addExerciseToSuperset(ex) {
                Haptic.selection();
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseObj = typeof ex === 'object' ? ex : {name: exerciseName, desc: '', image: ''};
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const res = await API.getHistory(exerciseName, 'last');
                const initialSets = (res.sets && res.sets.length) 
                    ? res.sets.map((s, idx) => {
                        let rest = s.rest || 0;
                        if (rest > 100) rest = rest / 60.0;
                        return {...s, rest, completed: false, id: Date.now() + idx + Math.random()};
                    })
                    : [{weight: 0, reps: 0, rest: 0, completed: false, id: Date.now()}];
                
                // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Å—É–ø–µ—Ä—Å–µ—Ç
                App.state.activeExercises.push({
                    name: exerciseName,
                    exerciseObj: exerciseObj,
                    sets: initialSets
                });
                
                UI.toggleModal('modalAddExercise', false);
                UI.renderWorkoutScreen();
            },

            async loadHistory() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏
                UI.toggleModal('modalHistory', true);
                const cont = document.getElementById('history-content');
                cont.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                
                // –ë–µ—Ä–µ–º –∏–º—è –ø–µ—Ä–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                const exerciseName = App.state.activeExercises.length > 0 
                    ? App.state.activeExercises[0].name 
                    : (App.state.exercise ? App.state.exercise.name : '');
                
                if (!exerciseName) {
                    cont.innerHTML = "–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ";
                    return;
                }
                
                const res = await API.getHistory(exerciseName);
                if (res.history) UI.renderHistory(res.history);
                else cont.innerHTML = "–ü—É—Å—Ç–æ";
            }
        };

        // ==================== UI RENDERER ====================
        const UI = {
            showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${id}`).classList.add('active');
                App.state.screen = id;
            },

            updateNav(title, back = false, history = false) {
                document.getElementById('navbarTitle').textContent = title;
                document.getElementById('btnBack').classList.toggle('hidden', !back);
                document.getElementById('btnHistory').classList.toggle('hidden', !history);
            },

            toggleModal(id, show) {
                const modal = document.getElementById(id);
                if (id === 'infoModal') {
                    modal.classList.toggle('open', show);
                } else {
                    modal.classList.toggle('active', show);
                }
            },

            renderLoading(id) {
                document.getElementById(id).innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            },

            renderGroups(groups) {
                const container = document.getElementById('groups-list');
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                const order = ['–°–ø–∏–Ω–∞', '–ù–æ–≥–∏', '–ì—Ä—É–¥—å', '–ü–ª–µ—á–∏', '–ë–∏—Ü–µ–ø—Å', '–¢—Ä–∏—Ü–µ–ø—Å', '–ö–∞—Ä–¥–∏–æ', '–ü—Ä–µ—Å—Å'];
                const sortedGroups = order.filter(g => groups.includes(g))
                    .concat(groups.filter(g => !order.includes(g)));
                
                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ 2
                let html = '<div class="groups-container"><div class="groups-grid">';
                for (let i = 0; i < sortedGroups.length; i += 2) {
                    html += '<div class="group-pair-row">';
                    html += `<div class="group-pair-item" onclick="App.selectGroup('${sortedGroups[i].replace(/'/g, "\\'")}')"><h3>${sortedGroups[i]}</h3></div>`;
                    if (sortedGroups[i + 1]) {
                        html += `<div class="group-pair-item" onclick="App.selectGroup('${sortedGroups[i + 1].replace(/'/g, "\\'")}')"><h3>${sortedGroups[i + 1]}</h3></div>`;
                    } else {
                        html += '<div class="group-pair-item" style="opacity: 0.5; cursor: default;"><h3>‚Äî</h3></div>';
                    }
                    html += '</div>';
                }
                html += '</div><div class="groups-footer"><button class="btn-all" onclick="App.loadAllExercises()">–í—Å–µ</button></div></div>';
                container.innerHTML = html;
            },

            renderExercises(list) {
                const container = document.getElementById('exercises-list');
                container.innerHTML = '<div class="list-grid">' +
                    list.map(ex => {
                        const exerciseName = typeof ex === 'string' ? ex : ex.name;
                        const exerciseDesc = typeof ex === 'object' ? (ex.desc || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') : '';
                        const exerciseImage = typeof ex === 'object' ? (ex.image || '') : '';
                        
                        const safeName = exerciseName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const safeDesc = exerciseDesc.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '\\n');
                        const safeImage = exerciseImage.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        
                        return `
                            <div class="list-item">
                                <div style="flex-grow: 1; cursor: pointer;" onclick='App.selectExercise(${JSON.stringify(ex)})'>
                                    <h3>${exerciseName}</h3>
                                </div>
                                <button class="info-btn" onclick='UI.showInfo(${JSON.stringify(ex)})'>i</button>
                            </div>
                        `;
                    }).join('') + '</div>';
            },

            renderSets(sets) {
                // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                const container = document.getElementById('sets-container');
                container.innerHTML = sets.map((set, index) => {
                    const setId = set.id || (Date.now() + index);
                    const safeId = JSON.stringify(setId);
                    return `
                        <div class="set-row ${set.completed ? 'completed' : ''}" data-id="${setId}">
                            <input type="checkbox" class="set-checkbox" ${set.completed ? 'checked disabled' : ''} 
                                   onchange="App.toggleSet(${safeId})">
                            <div class="set-inputs-group">
                                <div class="set-input-wrapper">
                                    <div class="input-label">–í–µ—Å</div>
                                    <input type="text" inputmode="decimal" class="set-input" 
                                           value="${String(set.weight || 0).replace(',', '.')}" 
                                           oninput="const val = UI.validateFloatInput(this); App.updateSetData(${safeId}, 'weight', val)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0">
                                </div>
                                <div class="set-input-wrapper">
                                    <div class="input-label">–ü–æ–≤—Ç–æ—Ä—ã</div>
                                    <input type="text" inputmode="numeric" class="set-input" 
                                           value="${set.reps || 0}" 
                                           oninput="App.updateSetData(${safeId}, 'reps', this.value)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0">
                                </div>
                                <div class="set-input-wrapper">
                                    <div class="input-label">–û—Ç–¥—ã—Ö (–º–∏–Ω)</div>
                                    <input type="text" inputmode="decimal" class="set-input" 
                                           value="${set.rest || 0}" 
                                           oninput="const val = UI.validateFloatInput(this); App.updateSetData(${safeId}, 'rest', val)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0" step="0.5">
                                </div>
                            </div>
                            <button class="set-remove ${set.completed ? 'hidden' : ''}" 
                                    onclick="App.removeSet(${safeId})">√ó</button>
                        </div>
                    `;
                }).join('');
            },

            renderWorkoutScreen() {
                const container = document.getElementById('sets-container');
                
                // –ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–µ—Ç (–±–∞–≥), –æ—á–∏—â–∞–µ–º
                if (!App.state.activeExercises || App.state.activeExercises.length === 0) {
                    container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è</div>';
                    return;
                }
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–æ—á–∫—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                const cardsHtml = App.state.activeExercises.map((exBlock, exIndex) => {
                    const exerciseName = exBlock.name;
                    const sets = exBlock.sets || [];
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –ø–æ–¥—Ö–æ–¥–æ–≤ (–∫–∞–∫ –±—ã–ª–æ, –Ω–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
                    const setsHtml = sets.map((set, setIndex) => {
                        const setId = set.id || (Date.now() + exIndex * 1000 + setIndex);
                        const safeId = JSON.stringify(setId); // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                        
                        return `
                            <div class="set-row ${set.completed ? 'completed' : ''}" data-ex-index="${exIndex}" data-set-id="${setId}">
                                <input type="checkbox" class="set-checkbox" ${set.completed ? 'checked disabled' : ''} 
                                       onchange="App.toggleSetInSuperset(${exIndex}, ${setIndex})">
                                
                                <div class="set-inputs-group">
                                    <div class="set-input-wrapper">
                                        <div class="input-label">–í–µ—Å</div>
                                        <input type="text" inputmode="decimal" class="set-input" 
                                               value="${String(set.weight || 0).replace(',', '.')}" 
                                               oninput="const val = UI.validateFloatInput(this); App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'weight', val)"
                                               onfocus="this.select()"
                                               ${set.completed ? 'disabled' : ''} placeholder="0">
                                    </div>
                                    <div class="set-input-wrapper">
                                        <div class="input-label">–ü–æ–≤—Ç</div>
                                        <input type="tel" inputmode="numeric" class="set-input" 
                                               value="${set.reps || 0}" 
                                               oninput="App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'reps', this.value)"
                                               onfocus="this.select()"
                                               ${set.completed ? 'disabled' : ''} placeholder="0">
                                    </div>
                                    <div class="set-input-wrapper">
                                        <div class="input-label">–û—Ç–¥(–º)</div>
                                        <input type="text" inputmode="decimal" class="set-input" 
                                               value="${set.rest || 0}" 
                                               oninput="const val = UI.validateFloatInput(this); App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'rest', val)"
                                               onfocus="this.select()"
                                               ${set.completed ? 'disabled' : ''} placeholder="0" step="0.5">
                                    </div>
                                </div>
                                
                                <button class="set-remove ${set.completed ? 'hidden' : ''}" 
                                        onclick="App.removeSetInSuperset(${exIndex}, ${setIndex})">√ó</button>
                            </div>
                        `;
                    }).join('');
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ü–µ–ª–∏–∫–æ–º
                    return `
                        <div class="exercise-card">
                            <div class="exercise-header">
                                <span class="exercise-title">${exIndex + 1}. ${exerciseName}</span>
                                ${exIndex > 0 ? `<button class="btn-remove-exercise" onclick="App.removeExerciseFromSuperset(${exIndex})">√ó</button>` : ''}
                            </div>
                            
                            <div class="exercise-sets">
                                ${setsHtml}
                            </div>
                            
                            <button class="btn-add-set-small" onclick="App.addSetToExercise(${exIndex})">
                                + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥
                            </button>
                        </div>
                    `;
                }).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" –≤ —Å–∞–º–æ–º –Ω–∏–∑—É
                const addExerciseBtn = `
                    <button class="btn-add-exercise-global" onclick="App.showAddExerciseModal()">
                        <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Å–µ—Ç
                    </button>
                `;
                
                container.innerHTML = cardsHtml + addExerciseBtn;
            },

            renderHistory(historyData) {
                const container = document.getElementById('history-content');
                container.innerHTML = '';
                
                if (!historyData || historyData.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                    return;
                }
                
                // 1. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –î–ê–¢–ï
                const byDate = {};
                historyData.forEach(item => {
                    let dateKey = String(item.date || '').split(',')[0].trim();
                    if (!dateKey) return;
                    
                    if (!byDate[dateKey]) byDate[dateKey] = {};
                    
                    // 2. –í–Ω—É—Ç—Ä–∏ –¥–∞—Ç—ã –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ set_group_id
                    const groupId = item.set_group_id || 'unknown_' + Math.random();
                    if (!byDate[dateKey][groupId]) byDate[dateKey][groupId] = [];
                    byDate[dateKey][groupId].push(item);
                });
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞—Ç
                const sortedDates = Object.keys(byDate).sort((a, b) => {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 23.11.2025 –≤ 2025-11-23 –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    const toISO = (d) => d.split('.').reverse().join('-');
                    return toISO(b).localeCompare(toISO(a));
                });
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
                let fullHtml = '';
                
                sortedDates.forEach(date => {
                    fullHtml += `<div class="history-date-header">üìÖ ${date}</div>`;
                    
                    const groupsInDate = byDate[date];
                    Object.values(groupsInDate).forEach(groupItems => {
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å—É–ø–µ—Ä—Å–µ—Ç —ç—Ç–æ –∏–ª–∏ –æ–±—ã—á–Ω—ã–π —Å–µ—Ç
                        // (–µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–µ –µ—Å—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏)
                        const uniqueNames = [...new Set(groupItems.map(i => i.exercise))];
                        const isSuperset = uniqueNames.length > 1;
                        
                        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
                        let headerHtml = '';
                        if (isSuperset) {
                            headerHtml = `
                                <div class="history-superset-header">
                                    <span class="badge-superset">–°—É–ø–µ—Ä—Å–µ—Ç</span>
                                    <span>${uniqueNames.join(' + ')}</span>
                                </div>
                            `;
                        }
                        
                        // –°–ø–∏—Å–æ–∫ –ø–æ–¥—Ö–æ–¥–æ–≤
                        const rowsHtml = groupItems.map(item => {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Å—É–ø–µ—Ä—Å–µ—Ç
                            const nameBlock = isSuperset 
                                ? `<div class="history-ex-name">${item.exercise}</div>` 
                                : '';
                            
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–¥—ã—Ö
                            let restDisplay = '';
                            if (item.rest) {
                                let restMinutes = item.rest;
                                if (restMinutes > 100) restMinutes = restMinutes / 60.0;
                                if (restMinutes % 1 === 0) {
                                    restDisplay = `${restMinutes}–º`;
                                } else {
                                    restDisplay = `${restMinutes.toFixed(1)}–º`;
                                }
                            }
                                
                            return `
                                <div class="history-item-row">
                                    <div>
                                        ${nameBlock}
                                        <div class="history-ex-vals">
                                            ${item.weight} –∫–≥ √ó ${item.reps}
                                        </div>
                                    </div>
                                    <div style="color:#aaa; font-size:12px;">
                                        ${restDisplay}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        fullHtml += `
                            <div class="history-superset-card">
                                ${headerHtml}
                                ${rowsHtml}
                            </div>
                        `;
                    });
                });
                
                container.innerHTML = fullHtml;
            },

            showInfo(ex) {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseDesc = typeof ex === 'object' ? (ex.desc || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') : '';
                const exerciseImage = typeof ex === 'object' ? (ex.image || '') : '';
                
                document.getElementById('modalTitle').textContent = exerciseName;
                const descEl = document.getElementById('modalDesc');
                descEl.textContent = (exerciseDesc && exerciseDesc !== 'undefined' && exerciseDesc !== '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') 
                    ? exerciseDesc 
                    : '–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.';
                
                const imgEl = document.getElementById('modalImage');
                if (exerciseImage && exerciseImage !== 'undefined' && exerciseImage !== '') {
                    imgEl.src = exerciseImage;
                    imgEl.style.display = 'block';
                } else {
                    imgEl.style.display = 'none';
                }
                
                this.toggleModal('infoModal', true);
            },

            validateFloatInput(input) {
                let val = input.value.replace(/[^0-9.,]/g, '');
                val = val.replace(',', '.');
                const parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join('');
                }
                if (input.value !== val) {
                    input.value = val;
                }
                return val;
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å HTML)
        function goBack() { App.goBack(); }
        function showHistory() { App.loadHistory(); }
        function closeHistory() { UI.toggleModal('modalHistory', false); }
        function openInfoModal(title, desc, image) { UI.showInfo({name: title, desc, image}); }
        function closeInfoModal(event) {
            if (event === null || event.target.id === 'infoModal') {
                UI.toggleModal('infoModal', false);
            }
        }
        function toggleTimer() { Timer.toggle(); }
        function resetTimer() { Timer.reset(); }
        function addSet() { App.addSetRow(); }

        // Start
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
