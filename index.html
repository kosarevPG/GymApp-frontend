<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Logger</title>
    
    <!-- Mobile Select CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-select@1.0.28/dist/mobile-select.min.css">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .back-btn {
            background: #f5f5f5;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .back-btn:active {
            background: #e0e0e0;
        }
        
        .list-item {
            padding: 16px;
            margin-bottom: 12px;
            background: #f9f9f9;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .list-item:active {
            background: #f0f0f0;
            border-color: #667eea;
        }
        
        .list-item h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .list-item p {
            font-size: 14px;
            color: #666;
        }
        
        .history-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .history-item .date {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }
        
        .history-item .data {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .picker-group {
            margin-bottom: 24px;
        }
        
        .picker-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: block;
        }
        
        .picker-input {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .picker-input:active {
            background: #f0f0f0;
            border-color: #667eea;
        }
        
        .buffer-info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            color: #1976d2;
            font-weight: 600;
        }
        
        .sets-list {
            margin-bottom: 20px;
        }
        
        .sets-list-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }
        
        .set-item {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .set-item-info {
            flex: 1;
        }
        
        .set-item-info strong {
            display: block;
            margin-bottom: 4px;
        }
        
        .set-item-remove {
            background: #ff5252;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:active {
            background: #e0e0e0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            color: #c62828;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω 1: –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã –º—ã—à—Ü -->
        <div id="screen-muscle-groups" class="screen active">
            <div class="header">
                <h1>üèãÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –º—ã—à—Ü</h1>
            </div>
            <div id="muscle-groups-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω 2: –í—ã–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
        <div id="screen-exercises" class="screen">
            <button class="back-btn" onclick="showMuscleGroups()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="header">
                <h1 id="muscle-group-title">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h1>
            </div>
            <div id="exercises-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω 3: –ò—Å—Ç–æ—Ä–∏—è –∏ –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
        <div id="screen-exercise-detail" class="screen">
            <button class="back-btn" onclick="showExercises()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="header">
                <h1 id="exercise-name">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h1>
            </div>
            
            <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥—Ö–æ–¥–æ–≤ -->
            <div id="history-section">
                <h2 style="font-size: 18px; margin-bottom: 12px; color: #333;">üìä –ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:</h2>
                <div id="history-list"></div>
            </div>
            
            <!-- –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
            <div style="margin-top: 24px;">
                <div id="bufferInfo" class="buffer-info hidden">
                    –í –±—É—Ñ–µ—Ä–µ: <span id="bufferCount">0</span> –ø–æ–¥—Ö–æ–¥(–æ–≤)
                </div>
                
                <div id="setsList" class="sets-list hidden">
                    <div class="sets-list-title">üìã –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã:</div>
                    <div id="setsListContent"></div>
                </div>
                
                <div class="picker-group">
                    <label class="picker-label">–í–µ—Å (–∫–≥)</label>
                    <input type="text" class="picker-input" id="weightPicker" readonly placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å">
                </div>
                
                <div class="picker-group">
                    <label class="picker-label">–ü–æ–≤—Ç–æ—Ä—ã</label>
                    <input type="text" class="picker-input" id="repsPicker" readonly placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–≤—Ç–æ—Ä—ã">
                </div>
                
                <div class="picker-group">
                    <label class="picker-label">–û—Ç–¥—ã—Ö</label>
                    <input type="text" class="picker-input" id="restPicker" readonly placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥—ã—Ö">
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="addToSetBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ—Ç (+)</button>
                    <button class="btn btn-primary" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã –∏ –∑–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Select JS -->
    <script src="https://cdn.jsdelivr.net/npm/mobile-select@1.0.28/dist/mobile-select.min.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (!tg) {
            console.error('‚ùå Telegram WebApp SDK not loaded');
            alert('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: WebApp –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ Telegram!');
        } else {
            tg.ready();
            tg.expand();
            console.log('‚úÖ Telegram WebApp initialized');
        }
        
        // URL –±—ç–∫–µ–Ω–¥–∞ (Render.com)
        const BACKEND_URL = 'https://gym-logger-bot-y602.onrender.com';
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentMuscleGroup = '';
        let currentExercise = '';
        let workoutBuffer = [];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadMuscleGroups();
            initPickers();
            initEventListeners();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø –º—ã—à—Ü
        async function loadMuscleGroups() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/muscle-groups`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayMuscleGroups(result.data);
                } else {
                    document.getElementById('muscle-groups-list').innerHTML = 
                        '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø –º—ã—à—Ü</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø –º—ã—à—Ü:', error);
                document.getElementById('muscle-groups-list').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</div>';
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–ø–ø –º—ã—à—Ü
        function displayMuscleGroups(groups) {
            const list = document.getElementById('muscle-groups-list');
            if (groups.length === 0) {
                list.innerHTML = '<div class="error">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø –º—ã—à—Ü</div>';
                return;
            }
            
            list.innerHTML = groups.map(group => `
                <div class="list-item" onclick="selectMuscleGroup('${group}')">
                    <h3>üí™ ${group}</h3>
                </div>
            `).join('');
        }
        
        // –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã –º—ã—à—Ü
        async function selectMuscleGroup(group) {
            currentMuscleGroup = group;
            document.getElementById('muscle-group-title').textContent = `üí™ ${group}`;
            showScreen('screen-exercises');
            await loadExercises(group);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        async function loadExercises(group) {
            const list = document.getElementById('exercises-list');
            list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/exercises?group=${encodeURIComponent(group)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayExercises(result.data);
                } else {
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', error);
                list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</div>';
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        function displayExercises(exercises) {
            const list = document.getElementById('exercises-list');
            if (exercises.length === 0) {
                list.innerHTML = '<div class="error">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
                return;
            }
            
            list.innerHTML = exercises.map(ex => `
                <div class="list-item" onclick="selectExercise('${ex.name.replace(/'/g, "\\'")}')">
                    <h3>üèãÔ∏è ${ex.name}</h3>
                </div>
            `).join('');
        }
        
        // –í—ã–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        async function selectExercise(exercise) {
            currentExercise = exercise;
            document.getElementById('exercise-name').textContent = exercise;
            showScreen('screen-exercise-detail');
            await loadExerciseHistory(exercise);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        async function loadExerciseHistory(exercise) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/exercise-history?exercise=${encodeURIComponent(exercise)}&limit=10`);
                const result = await response.json();
                
                if (result.status === 'success' && result.data.length > 0) {
                    displayHistory(result.data);
                } else {
                    historyList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                historyList.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        function displayHistory(history) {
            const historyList = document.getElementById('history-list');
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ set_group_id –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–æ–≤ –≤–º–µ—Å—Ç–µ
            const grouped = {};
            history.forEach(item => {
                const key = item.set_group_id || 'single';
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(item);
            });
            
            historyList.innerHTML = Object.values(grouped).slice(0, 1).map(group => {
                const date = group[0].date;
                return `
                    <div class="history-item">
                        <div class="date">${date}</div>
                        ${group.map(set => `
                            <div class="data">
                                ${set.weight}–∫–≥ √ó ${set.reps}${set.rest ? ` (–æ—Ç–¥—ã—Ö: ${set.rest}—Å)` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        function showMuscleGroups() {
            showScreen('screen-muscle-groups');
        }
        
        function showExercises() {
            if (currentMuscleGroup) {
                showScreen('screen-exercises');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è pickers (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏)
        let weightPicker, repsPicker, restPicker;
        
        function initPickers() {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≤–µ—Å–∞
            function generateWeightValues() {
                const values = [];
                for (let i = 0; i <= 300; i += 1.25) {
                    values.push(i.toFixed(2));
                }
                return values;
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –ø–æ–≤—Ç–æ—Ä–æ–≤
            function generateRepsValues() {
                const values = [];
                for (let i = 0; i <= 100; i++) {
                    values.push(i.toString());
                }
                return values;
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –æ—Ç–¥—ã—Ö–∞
            function generateRestValues() {
                const values = [];
                for (let i = 0; i <= 600; i += 15) {
                    const minutes = Math.floor(i / 60);
                    const seconds = i % 60;
                    values.push(`${minutes}:${seconds.toString().padStart(2, '0')}`);
                }
                return values;
            }
            
            try {
                weightPicker = new MobileSelect({
                    trigger: '#weightPicker',
                    title: '–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å (–∫–≥)',
                    wheels: [{ data: generateWeightValues() }],
                    onOk: (data) => {
                        document.getElementById('weightPicker').value = data[0] + ' –∫–≥';
                    }
                });
                
                repsPicker = new MobileSelect({
                    trigger: '#repsPicker',
                    title: '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–≤—Ç–æ—Ä—ã',
                    wheels: [{ data: generateRepsValues() }],
                    onOk: (data) => {
                        document.getElementById('repsPicker').value = data[0] + ' —Ä–∞–∑';
                    }
                });
                
                restPicker = new MobileSelect({
                    trigger: '#restPicker',
                    title: '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥—ã—Ö',
                    wheels: [{ data: generateRestValues() }],
                    onOk: (data) => {
                        const [minutes, seconds] = data[0].split(':');
                        const totalSeconds = parseInt(minutes) * 60 + parseInt(seconds);
                        document.getElementById('restPicker').value = data[0] + ' (—Å–µ–∫: ' + totalSeconds + ')';
                        document.getElementById('restPicker').dataset.seconds = totalSeconds;
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ pickers:', error);
                // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–µ input
                document.getElementById('weightPicker').type = 'number';
                document.getElementById('repsPicker').type = 'number';
                document.getElementById('restPicker').type = 'number';
            }
        }
        
        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥—Ö–æ–¥–∞–º–∏ (–∏–∑ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏)
        function initEventListeners() {
            document.getElementById('addToSetBtn').addEventListener('click', addToSet);
            document.getElementById('saveBtn').addEventListener('click', saveWorkout);
        }
        
        function getCurrentValues() {
            const weightStr = document.getElementById('weightPicker').value.replace(' –∫–≥', '').trim();
            const repsStr = document.getElementById('repsPicker').value.replace(' —Ä–∞–∑', '').trim();
            const restInput = document.getElementById('restPicker');
            const restSeconds = restInput.dataset.seconds || restInput.value.replace(/[^0-9]/g, '') || 0;
            
            return {
                weight: parseFloat(weightStr) || 0,
                reps: parseInt(repsStr) || 0,
                rest: parseInt(restSeconds) || 0
            };
        }
        
        function addToSet() {
            const current = getCurrentValues();
            
            if (current.weight === 0 && current.reps === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã');
                return;
            }
            
            workoutBuffer.push({
                exercise: currentExercise,
                weight: current.weight,
                reps: current.reps,
                rest: current.rest
            });
            
            updateBufferInfo();
            updateSetsList();
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('weightPicker').value = '';
            document.getElementById('repsPicker').value = '';
            document.getElementById('restPicker').value = '';
            document.getElementById('restPicker').dataset.seconds = '';
        }
        
        function updateBufferInfo() {
            const count = workoutBuffer.length;
            const info = document.getElementById('bufferInfo');
            const countSpan = document.getElementById('bufferCount');
            
            if (count > 0) {
                info.classList.remove('hidden');
                countSpan.textContent = count;
            } else {
                info.classList.add('hidden');
            }
        }
        
        function updateSetsList() {
            const list = document.getElementById('setsList');
            const content = document.getElementById('setsListContent');
            
            if (workoutBuffer.length > 0) {
                list.classList.remove('hidden');
                content.innerHTML = workoutBuffer.map((set, index) => `
                    <div class="set-item">
                        <div class="set-item-info">
                            <strong>–ü–æ–¥—Ö–æ–¥ ${index + 1}</strong>
                            ${set.weight}–∫–≥ √ó ${set.reps}${set.rest ? ` (–æ—Ç–¥—ã—Ö: ${set.rest}—Å)` : ''}
                        </div>
                        <button class="set-item-remove" onclick="removeSet(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `).join('');
            } else {
                list.classList.add('hidden');
            }
        }
        
        function removeSet(index) {
            workoutBuffer.splice(index, 1);
            updateBufferInfo();
            updateSetsList();
        }
        
        async function saveWorkout() {
            const setsCount = workoutBuffer.length;
            
            if (setsCount === 0) {
                const current = getCurrentValues();
                if (current.weight === 0 && current.reps === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º');
                    return;
                }
                workoutBuffer.push({
                    exercise: currentExercise,
                    weight: current.weight,
                    reps: current.reps,
                    rest: current.rest
                });
            }
            
            let userId = null;
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userId = tg.initDataUnsafe.user.id;
            }
            
            const finalData = {
                type: "workout_data",
                payload: workoutBuffer,
                user_id: userId
            };
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/webapp-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(finalData)
                });
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${setsCount} –ø–æ–¥—Ö–æ–¥–æ–≤!\n\n${result.message || '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É.'}`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    if (tg && tg.close) {
                        tg.close();
                    }
                } else {
                    throw new Error(result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }
    </script>
</body>
</html>
