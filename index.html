<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Logger</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        /* Navbar */
        .navbar {
            background: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-left {
            width: 80px;
        }
        
        .navbar-center {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .navbar-right {
            width: 80px;
            text-align: right;
        }
        
        .btn-nav {
            background: none;
            border: none;
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
        }
        
        .btn-nav:active {
            opacity: 0.7;
        }
        
        .btn-nav.hidden {
            visibility: hidden;
        }
        
        /* Container */
        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Screen */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* Screen 1 & 2: Groups and Exercises */
        .list-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .list-item {
            background: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .list-item:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        
        .list-item h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        /* Screen 3: Workout */
        .workout-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .set-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .set-row.completed {
            background: #e8f5e9;
            border-color: #4caf50;
            opacity: 0.8;
        }
        
        .set-row.completed input {
            background: #c8e6c9;
            color: #2e7d32;
        }
        
        .set-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .set-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            background: white;
        }
        
        .set-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .set-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .set-remove {
            background: #ff5252;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .set-remove:active {
            background: #d32f2f;
        }
        
        .set-remove.hidden {
            display: none;
        }
        
        .btn-add-set {
            width: 100%;
            padding: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }
        
        .btn-add-set:active {
            background: #5568d3;
        }
        
        .input-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            text-align: center;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .history-item {
            padding: 16px;
            margin-bottom: 12px;
            background: #f9f9f9;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .history-date {
            font-size: 14px;
            color: #999;
            margin-bottom: 8px;
        }
        
        .history-sets {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .history-set {
            font-size: 16px;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 16px;
        }
        
        .error {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 16px;
            margin: 20px;
            color: #c62828;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-left">
            <button class="btn-nav" id="btnBack" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <div class="navbar-center" id="navbarTitle">Gym Logger</div>
        <div class="navbar-right">
            <button class="btn-nav hidden" id="btnHistory" onclick="showHistory()">üìñ –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Screen 1: Groups -->
        <div id="screen-groups" class="screen active">
            <div id="groups-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø –º—ã—à—Ü...</div>
        </div>
        
        <!-- Screen 2: Exercises -->
        <div id="screen-exercises" class="screen">
            <div id="exercises-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>
        </div>
        
        <!-- Screen 3: Workout -->
        <div id="screen-workout" class="screen">
            <div class="workout-container">
                <div id="sets-container"></div>
                <button class="btn-add-set" onclick="addSet()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: History -->
    <div id="modalHistory" class="modal" onclick="if(event.target === this) closeHistory()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìñ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                <button class="modal-close" onclick="closeHistory()">√ó</button>
            </div>
            <div id="history-content" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
        </div>
    </div>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (!tg) {
            console.error('Telegram WebApp SDK not loaded');
        } else {
            tg.ready();
            tg.expand();
        }
        
        // URL –±—ç–∫–µ–Ω–¥–∞
        const BACKEND_URL = 'https://gym-logger-bot-y602.onrender.com';
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentScreen = 'groups';
        let currentGroup = '';
        let currentExercise = '';
        let sets = [];
        let userId = null;
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ user_id
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userId = tg.initDataUnsafe.user.id;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            await loadGroups();
        });
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${screen}`).classList.add('active');
            currentScreen = screen;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Navbar
            const btnBack = document.getElementById('btnBack');
            const btnHistory = document.getElementById('btnHistory');
            const navbarTitle = document.getElementById('navbarTitle');
            
            if (screen === 'groups') {
                btnBack.classList.add('hidden');
                btnHistory.classList.add('hidden');
                navbarTitle.textContent = 'Gym Logger';
            } else if (screen === 'exercises') {
                btnBack.classList.remove('hidden');
                btnHistory.classList.add('hidden');
                navbarTitle.textContent = currentGroup;
            } else if (screen === 'workout') {
                btnBack.classList.remove('hidden');
                btnHistory.classList.remove('hidden');
                navbarTitle.textContent = currentExercise;
            }
        }
        
        function goBack() {
            if (currentScreen === 'exercises') {
                showScreen('groups');
            } else if (currentScreen === 'workout') {
                showScreen('exercises');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø –º—ã—à—Ü
        async function loadGroups() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/groups`);
                const result = await response.json();
                
                if (result.groups && result.groups.length > 0) {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                    const order = ['–°–ø–∏–Ω–∞', '–ù–æ–≥–∏', '–ì—Ä—É–¥—å', '–ü–ª–µ—á–∏', '–ë–∏—Ü–µ–ø—Å', '–¢—Ä–∏—Ü–µ–ø—Å', '–ö–∞—Ä–¥–∏–æ', '–ü—Ä–µ—Å—Å'];
                    const sortedGroups = order.filter(group => result.groups.includes(group))
                        .concat(result.groups.filter(group => !order.includes(group)));
                    displayGroups(sortedGroups);
                } else {
                    document.getElementById('groups-list').innerHTML = 
                        '<div class="error">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø –º—ã—à—Ü</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
                document.getElementById('groups-list').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</div>';
            }
        }
        
        function displayGroups(groups) {
            const list = document.getElementById('groups-list');
            list.innerHTML = '<div class="list-grid">' +
                groups.map(group => `
                    <div class="list-item" onclick="selectGroup('${group.replace(/'/g, "\\'")}')">
                        <h3>üí™ ${group}</h3>
                    </div>
                `).join('') + '</div>';
        }
        
        // –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã
        async function selectGroup(group) {
            currentGroup = group;
            showScreen('exercises');
            await loadExercises(group);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        async function loadExercises(group) {
            const list = document.getElementById('exercises-list');
            list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/exercises?group=${encodeURIComponent(group)}`);
                const result = await response.json();
                
                if (result.exercises && result.exercises.length > 0) {
                    displayExercises(result.exercises);
                } else {
                    list.innerHTML = '<div class="error">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', error);
                list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</div>';
            }
        }
        
        function displayExercises(exercises) {
            const list = document.getElementById('exercises-list');
            list.innerHTML = '<div class="list-grid">' +
                exercises.map(ex => `
                    <div class="list-item" onclick="selectExercise('${ex.replace(/'/g, "\\'")}')">
                        <h3>üèãÔ∏è ${ex}</h3>
                    </div>
                `).join('') + '</div>';
        }
        
        // –í—ã–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        async function selectExercise(exercise) {
            currentExercise = exercise;
            showScreen('workout');
            await loadWorkout(exercise);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)
        async function loadWorkout(exercise) {
            const container = document.getElementById('sets-container');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/history?exercise=${encodeURIComponent(exercise)}&mode=last`);
                const result = await response.json();
                
                if (result.sets && result.sets.length > 0) {
                    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                    sets = result.sets.map(set => ({
                        ...set,
                        completed: false,
                        id: Date.now() + Math.random()
                    }));
                } else {
                    // –°–æ–∑–¥–∞–µ–º –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                    sets = [{
                        weight: 0,
                        reps: 0,
                        rest: 0,
                        completed: false,
                        id: Date.now()
                    }];
                }
                
                renderSets();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
                // –°–æ–∑–¥–∞–µ–º –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                sets = [{
                    weight: 0,
                    reps: 0,
                    rest: 0,
                    completed: false,
                    id: Date.now()
                }];
                renderSets();
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤
        function renderSets() {
            const container = document.getElementById('sets-container');
            container.innerHTML = sets.map((set, index) => `
                <div class="set-row ${set.completed ? 'completed' : ''}" data-id="${set.id}">
                    <input type="checkbox" class="set-checkbox" ${set.completed ? 'checked' : ''} 
                           onchange="toggleSet(${index})" ${set.completed ? 'disabled' : ''}>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                        <div>
                            <div class="input-label">–í–µ—Å (–∫–≥)</div>
                            <input type="number" class="set-input" value="${set.weight}" 
                                   onchange="updateSet(${index}, 'weight', this.value)"
                                   ${set.completed ? 'disabled' : ''} placeholder="0">
                        </div>
                        <div>
                            <div class="input-label">–ü–æ–≤—Ç–æ—Ä—ã</div>
                            <input type="number" class="set-input" value="${set.reps}" 
                                   onchange="updateSet(${index}, 'reps', this.value)"
                                   ${set.completed ? 'disabled' : ''} placeholder="0">
                        </div>
                        <div>
                            <div class="input-label">–û—Ç–¥—ã—Ö (—Å–µ–∫)</div>
                            <input type="number" class="set-input" value="${set.rest}" 
                                   onchange="updateSet(${index}, 'rest', this.value)"
                                   ${set.completed ? 'disabled' : ''} placeholder="0">
                        </div>
                    </div>
                    <button class="set-remove ${set.completed ? 'hidden' : ''}" 
                            onclick="removeSet(${index})">√ó</button>
                </div>
            `).join('');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞
        function updateSet(index, field, value) {
            if (sets[index] && !sets[index].completed) {
                sets[index][field] = parseFloat(value) || 0;
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞
        function addSet() {
            sets.push({
                weight: 0,
                reps: 0,
                rest: 0,
                completed: false,
                id: Date.now() + Math.random()
            });
            renderSets();
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞
        function removeSet(index) {
            if (!sets[index].completed) {
                sets.splice(index, 1);
                renderSets();
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–∞
        async function toggleSet(index) {
            const set = sets[index];
            if (set.completed) {
                // –ó–∞–ø—Ä–µ—Ç –æ—Ç–º–µ–Ω—ã
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏
            if (!set.weight || !set.reps) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã');
                document.querySelector(`[data-id="${set.id}"] .set-checkbox`).checked = false;
                return;
            }
            
            // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π
            set.completed = true;
            renderSets();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            try {
                const response = await fetch(`${BACKEND_URL}/api/save_set`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        exercise: currentExercise,
                        weight: set.weight,
                        reps: set.reps,
                        rest: set.rest || 0
                    })
                });
                
                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–∞: ' + error.message);
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                set.completed = false;
                renderSets();
            }
        }
        
        // –ò—Å—Ç–æ—Ä–∏—è
        async function showHistory() {
            const modal = document.getElementById('modalHistory');
            const content = document.getElementById('history-content');
            modal.classList.add('active');
            content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/history?exercise=${encodeURIComponent(currentExercise)}&mode=full&limit=20`);
                const result = await response.json();
                
                if (result.history && result.history.length > 0) {
                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏ set_group_id
                    const grouped = {};
                    result.history.forEach(item => {
                        const key = `${item.date}_${item.set_group_id}`;
                        if (!grouped[key]) {
                            grouped[key] = {
                                date: item.date,
                                sets: []
                            };
                        }
                        grouped[key].sets.push(item);
                    });
                    
                    content.innerHTML = Object.values(grouped).map(group => `
                        <div class="history-item">
                            <div class="history-date">${group.date}</div>
                            <div class="history-sets">
                                ${group.sets.map(set => `
                                    <div class="history-set">
                                        ${set.weight}–∫–≥ √ó ${set.reps}${set.rest ? ` (–æ—Ç–¥—ã—Ö: ${set.rest}—Å)` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                content.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
            }
        }
        
        function closeHistory() {
            document.getElementById('modalHistory').classList.remove('active');
        }
    </script>
</body>
</html>
