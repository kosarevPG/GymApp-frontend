<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymApp</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --input-bg: #2c2c2e;
            --text-color: #ffffff;
            --text-secondary: #8e8e93;
            --accent: #0a84ff;
            --danger: #ff453a;
            --success: #30d158;
            --separator: #2c2c2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; 
            padding-bottom: 80px;
        }
        
        /* Navbar */
        .navbar {
            background: var(--bg-color);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            height: 44px; /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –∫–∞–∫ –≤ iOS */
        }
        
        .navbar-center { 
            font-size: 17px; 
            font-weight: 600; 
        }
        
        .btn-nav { 
            background: none; 
            border: none; 
            color: var(--accent); 
            font-size: 17px; 
            cursor: pointer; 
            padding: 0; 
        }
        
        .btn-nav.hidden { 
            visibility: hidden; 
        }
        
        /* Search Bar */
        .search-wrapper {
            padding: 0 16px 10px 16px;
            background: var(--bg-color);
            position: sticky;
            top: 44px; /* –û—Ç—Å—Ç—É–ø —Ä–∞–≤–µ–Ω –≤—ã—Å–æ—Ç–µ navbar */
            z-index: 90;
        }
        
        .search-input {
            width: 100%;
            background: var(--input-bg);
            border: none;
            border-radius: 10px;
            padding: 12px 12px 12px 40px;
            color: var(--text-color);
            font-size: 17px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%238e8e93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
        }
        
        .search-input:focus { 
            outline: none; 
            background-color: #3a3a3c; 
        }
        
        .search-input::placeholder { 
            color: #636366; 
        }
        
        /* Container */
        .container {
            padding: 0;
        }
        
        /* Screen */
        .screen {
            display: none;
            padding-bottom: 80px;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* --- Lists --- */
        .list-container { padding: 0 16px; }
        .list-item {
            display: flex; align-items: center; padding: 12px 0;
            border-bottom: 1px solid var(--separator); cursor: pointer;
        }
        .list-item:last-child { border-bottom: none; }

        .list-img {
            width: 56px; height: 56px; border-radius: 8px; object-fit: cover;
            background: #333; margin-right: 16px; flex-shrink: 0;
        }
        .list-img.placeholder {
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; background: var(--input-bg); color: #555;
        }
        .list-content { flex: 1; display: flex; align-items: center; justify-content: space-between; }
        .list-title { font-size: 17px; font-weight: 500; }
        .list-arrow { color: #3a3a3c; font-size: 20px; }
        
        .groups-container {
            display: flex;
            flex-direction: column;
        }
        
        .groups-footer {
            padding: 20px 16px;
            display: flex;
            justify-content: center;
        }
        
        .btn-all {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            max-width: 200px;
        }
        
        .btn-all:active {
            opacity: 0.7;
        }
        
        /* --- Workout Screen --- */
        .timer-card {
            background: var(--bg-color); padding: 10px 16px; margin-bottom: 20px;
            display: flex; justify-content: center; gap: 15px;
        }
        .timer-display { font-size: 36px; font-weight: 700; font-variant-numeric: tabular-nums; }
        .timer-btn { 
            border: none; padding: 8px 16px; border-radius: 20px; 
            font-size: 15px; font-weight: 600; cursor: pointer; 
        }
        .timer-btn.start { background: rgba(10, 132, 255, 0.15); color: var(--accent); }
        .timer-btn.start.active { background: rgba(255, 69, 58, 0.15); color: var(--danger); }
        .timer-btn.reset { background: var(--input-bg); color: var(--text-secondary); }

        .exercise-card {
            background: var(--card-bg); margin: 0 16px 24px 16px;
            border-radius: 16px; padding: 20px; position: relative;
        }
        .exercise-header {
            display: flex; justify-content: space-between; margin-bottom: 12px;
            border-bottom: 1px solid var(--separator); padding-bottom: 8px;
        }
        .exercise-title { font-size: 17px; font-weight: 700; }

        .set-row {
            display: grid; grid-template-columns: 30px 1fr 1fr 1fr 30px;
            gap: 8px; align-items: center; margin-bottom: 10px;
        }
        .set-row.completed { opacity: 0.4; }
        
        .set-input {
            background: var(--input-bg); border: none; color: white;
            border-radius: 8px; padding: 10px 5px; text-align: center;
            font-size: 17px; width: 100%;
        }
        
        .set-checkbox {
            width: 24px; height: 24px; border-radius: 6px;
            border: 2px solid var(--text-secondary); appearance: none;
            background: transparent; cursor: pointer; justify-self: center;
        }
        .set-checkbox:checked { background: var(--success); border-color: var(--success); }
        
        .sets-header {
            display: grid; grid-template-columns: 30px 1fr 1fr 1fr 30px;
            gap: 8px; margin-bottom: 8px; padding: 0 2px;
        }
        .col-title { font-size: 12px; color: var(--text-secondary); text-align: center; }

        .note-wrapper {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255, 214, 10, 0.1); border: 1px solid rgba(255, 214, 10, 0.3);
            padding: 10px 12px; border-radius: 8px; margin-bottom: 20px;
        }
        .note-input { background: transparent; border: none; color: #ffd60a; width: 100%; font-size: 14px; }

        .stats-row {
            grid-column: 2 / span 3; display: flex; justify-content: space-between;
            font-size: 11px; margin-top: -4px; padding: 0 4px;
        }
        .stat-1rm { color: var(--text-secondary); }
        .stat-delta.positive { color: var(--success); }
        .stat-delta.negative { color: var(--danger); }

        /* --- Buttons --- */
        .btn-add-set-small {
            background: var(--input-bg); color: var(--accent); border: none;
            width: 100%; padding: 12px; border-radius: 10px;
            font-weight: 600; font-size: 15px; margin-top: 10px; cursor: pointer;
        }
        .btn-add-exercise-global {
            width: calc(100% - 32px); margin: 10px 16px 40px 16px; padding: 16px;
            background: var(--card-bg); color: var(--accent);
            border: 2px dashed var(--accent); border-radius: 16px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-remove-exercise {
            background: #2c1a1a; color: var(--danger); border: none;
            border-radius: 8px; padding: 6px 10px; font-weight: bold; cursor: pointer;
        }
        .set-remove {
            background: rgba(255, 69, 58, 0.2); color: var(--danger); border: none;
            width: 28px; height: 28px; border-radius: 6px; font-size: 18px;
            display: flex; justify-content: center; align-items: center; cursor: pointer; justify-self: center;
        }
        
        /* --- MODALS (FIXED) --- */
        /* –≠—Ç–æ—Ç –±–ª–æ–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω, —á—Ç–æ–±—ã –æ–∫–Ω–∞ –±—ã–ª–∏ —Å–∫—Ä—ã—Ç—ã! */
        .modal, .modal-overlay {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(5px);
            z-index: 2000; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
        }
        
        /* –ö–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –æ–∫–Ω–æ –≤–∏–¥–∏–º—ã–º */
        .modal.active, .modal-overlay.open { 
            display: flex !important; 
        }

        /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
        .modal-card, .modal-content {
            background: var(--card-bg); 
            color: var(--text-color);
            border-radius: 16px; 
            width: 100%; 
            max-width: 350px;
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 16px; 
            border-bottom: 1px solid var(--separator);
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }
        
        .modal-title, h3 { 
            margin: 0; 
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close { 
            background: none; 
            border: none;
            color: var(--accent); 
            font-size: 24px; 
            cursor: pointer;
            line-height: 1; 
            padding: 0; 
        }
        
        .modal-body { padding: 20px; }
        
        .modal-img {
            width: 100%; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            object-fit: cover; 
            background: var(--input-bg); 
            min-height: 200px;
        }
        
        .modal-desc {
            font-size: 15px; 
            line-height: 1.5; 
            color: var(--text-color); 
            margin: 0; 
            white-space: pre-wrap;
        }
        
        /* History styles */
        .history-item {
            padding: 16px; margin-bottom: 12px; background: var(--card-bg);
            border-radius: 12px; border-left: 4px solid var(--accent);
        }
        .history-date { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .history-sets { display: flex; flex-direction: column; gap: 4px; }
        .history-set { font-size: 16px; color: var(--text-color); }
        .history-group-card {
            background: var(--card-bg); border-radius: 12px; padding: 12px;
            margin-bottom: 12px; border-left: 4px solid var(--accent);
        }
        .history-date-header {
            font-size: 14px; font-weight: 700; color: var(--text-color);
            margin-bottom: 8px; display: flex; justify-content: space-between; opacity: 0.8;
        }
        .history-sets-list { display: flex; flex-direction: column; gap: 4px; }
        .history-set-row {
            font-size: 15px; color: var(--text-color); display: flex;
            justify-content: space-between; border-bottom: 1px dashed var(--separator); padding-bottom: 2px;
        }
        .history-set-row:last-child { border-bottom: none; }
        .history-rest { font-size: 12px; color: var(--text-secondary); margin-left: 8px; }
        .history-superset-card {
            background: var(--card-bg); border: 1px solid var(--separator);
            border-radius: 12px; margin-bottom: 12px; overflow: hidden;
        }
        .history-superset-header {
            background: #2c2c2e; padding: 8px 12px; font-size: 13px; font-weight: 600;
            color: var(--accent); border-bottom: 1px solid var(--separator);
            display: flex; align-items: center; gap: 6px;
        }
        .badge-superset {
            background: var(--accent); color: white; font-size: 10px;
            padding: 2px 6px; border-radius: 4px; text-transform: uppercase;
        }
        .history-item-row {
            padding: 8px 12px; border-bottom: 1px dashed var(--separator);
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-item-row:last-child { border-bottom: none; }
        .history-ex-name { font-size: 12px; color: var(--text-secondary); margin-bottom: 2px; }
        .history-ex-vals { font-size: 14px; color: var(--text-color); font-weight: 500; }
        
        /* --- Utils --- */
        .loading { color: var(--text-secondary); text-align: center; margin-top: 40px; }
        .error { color: var(--danger); text-align: center; margin-top: 40px; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-left">
            <button class="btn-nav" id="btnBack">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <div class="navbar-center" id="navbarTitle"></div>
        <div class="navbar-right">
            <button class="btn-nav hidden" id="btnHistory">üìñ –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
        </div>
        
    <div class="container">
        <!-- Screen 1: Groups -->
        <div id="screen-groups" class="screen active">
            <div class="search-wrapper">
                <input type="text" id="searchGroups" class="search-input" 
                       placeholder="–ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π" autocomplete="off" 
                       oninput="UI.filterGlobal(this.value)">
            </div>
            <div id="groups-list" class="list-container loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- Screen 2: Exercises -->
        <div id="screen-exercises" class="screen">
            <div class="search-wrapper">
                <input type="text" id="searchExercises" class="search-input" 
                       placeholder="–ù–∞–π—Ç–∏ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ" autocomplete="off" 
                       oninput="UI.filterExercises(this.value)">
            </div>
            <div id="exercises-list" class="list-container loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- Screen 3: Workout -->
        <div id="screen-workout" class="screen">
            <div class="workout-container">
                <div class="timer-card">
                    <div class="timer-display" id="timerDisplay">00:00</div>
                    <button class="timer-btn start" id="timerStartBtn">–°—Ç–∞—Ä—Ç</button>
                    <button class="timer-btn reset" id="timerResetBtn">–°–±—Ä–æ—Å</button>
                </div>
                <div id="sets-container"></div>
            </div>
        </div>
        </div>
        
    <!-- Modal: History -->
    <div id="modalHistory" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìñ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                <button class="modal-close" id="closeHistoryBtn">√ó</button>
            </div>
            <div id="history-content" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
        </div>
        </div>
        
    <!-- Modal: Exercise Info -->
    <div id="infoModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modalTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                <button class="modal-close" id="closeInfoBtn">‚úï</button>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="–¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è" class="modal-img">
                <p id="modalDesc" class="modal-desc">–û–ø–∏—Å–∞–Ω–∏–µ...</p>
            </div>
        </div>
        </div>
        
    <!-- Modal: Add Exercise to Superset -->
    <div id="modalAddExercise" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>
                <button class="modal-close" onclick="UI.toggleModal('modalAddExercise', false)">√ó</button>
            </div>
            <div id="add-exercise-list" class="list-container"></div>
        </div>
    </div>
    
    <script>
        // ==================== CONFIG ====================
        const CONFIG = {
            // ‚ö†Ô∏è –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–¥—Ä–µ—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤–∞—à–∏–º —Ä–µ–∞–ª—å–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º –Ω–∞ Render.com
            // –í –∫–æ–Ω—Ü–µ –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–ª–µ—à–∞ "/"
            BACKEND_URL: 'https://gym-logger-bot-y602.onrender.com',
            USER_ID: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null
        };
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log('[CONFIG] Backend URL:', CONFIG.BACKEND_URL);
        console.log('[CONFIG] User ID:', CONFIG.USER_ID);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // ==================== HAPTIC FEEDBACK ====================
        const Haptic = {
            // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ –≤–∏–±—Ä–∞—Ü–∏–∏
            impact(style = 'medium') {
                try {
                    if (tg?.HapticFeedback?.impactOccurred) {
                        tg.HapticFeedback.impactOccurred(style); // 'light', 'medium', 'heavy', 'rigid', 'soft'
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –≤–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                }
            },
            
            selection() {
                try {
                    if (tg?.HapticFeedback?.selectionChanged) {
                        tg.HapticFeedback.selectionChanged();
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                }
            },
            
            notification(type = 'success') {
                try {
                    if (tg?.HapticFeedback?.notificationOccurred) {
                        tg.HapticFeedback.notificationOccurred(type); // 'error', 'success', 'warning'
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                }
            }
        };

        // ==================== API MODULE ====================
        // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ JSON
        const fixDoubleSerialization = (data) => {
            if (!data) return data;
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
            if (typeof data === 'string') {
                try {
                    return JSON.parse(data);
                } catch (e) {
                    console.warn('[API] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä–æ–∫—É:', e);
                    return data;
                }
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ —Å –æ–¥–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º-—Å—Ç—Ä–æ–∫–æ–π, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π JSON
            if (Array.isArray(data) && data.length === 1 && typeof data[0] === 'string' && (data[0].includes('[') || data[0].includes('{'))) {
                try {
                    return JSON.parse(data[0]);
                } catch (e) {
                    console.warn('[API] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –º–∞—Å—Å–∏–≤ —Å–æ —Å—Ç—Ä–æ–∫–æ–π:', e);
                    return data;
                }
            }
            
            return data;
        };
        
        const API = {
            async request(endpoint, params = {}, method = 'GET', body = null) {
                const url = new URL(`${CONFIG.BACKEND_URL}/api/${endpoint}`);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                
                try {
                    const opts = { 
                        method, 
                        headers: { 'Content-Type': 'application/json' },
                        // –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥ (–¥–ª—è "–ø—Ä–æ—Å—ã–ø–∞—é—â–µ–≥–æ—Å—è" Render —Å–µ—Ä–≤–µ—Ä–∞)
                        signal: AbortSignal.timeout(30000)
                    };
                    if (body) opts.body = JSON.stringify(body);
                    
                    console.log(`[API] –ó–∞–ø—Ä–æ—Å: ${method} ${url}`);
                    const res = await fetch(url, opts);
                    
                    if (!res.ok) {
                        console.error(`[API] –û—à–∏–±–∫–∞ HTTP: ${res.status} ${res.statusText}`);
                        return { error: true, message: `HTTP ${res.status}` };
                    }
                    
                    const data = await res.json();
                    console.log(`[API] –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:`, data);
                    return data;
                } catch (e) {
                    if (e.name === 'TimeoutError') {
                        console.error("[API] –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (30 —Å–µ–∫). –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.");
                        return { error: true, message: '–¢–∞–π–º–∞—É—Ç. –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.' };
                    } else if (e.name === 'TypeError' && e.message.includes('Failed to fetch')) {
                        console.error("[API] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É:", CONFIG.BACKEND_URL);
                        return { error: true, message: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å.' };
        } else {
                        console.error("[API] –û—à–∏–±–∫–∞:", e);
                        return { error: true, message: e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' };
                    }
                }
            },

            getGroups: () => API.request('groups'),
            getExercises: (group) => API.request('exercises', { group }),
            getHistory: (exercise, mode = 'full', limit = 20) => API.request('history', { exercise, mode, limit }),
            saveSet: (data) => API.request('save_set', {}, 'POST', { 
                ...data, 
                user_id: CONFIG.USER_ID,
                set_group_id: App.state.sessionId // –ü–µ—Ä–µ–¥–∞–µ–º sessionId –¥–ª—è —Å—É–ø–µ—Ä—Å–µ—Ç–æ–≤
            })
        };

        // ==================== TIMER MODULE ====================
        const Timer = {
            interval: null,
            startTime: 0,
            accumulated: 0,
            running: false,
            
            formatTime(totalMilliseconds) {
                const totalSeconds = Math.floor(totalMilliseconds / 1000);
                const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const s = (totalSeconds % 60).toString().padStart(2, '0');
                const ms = Math.floor((totalMilliseconds % 1000) / 10).toString().padStart(2, '0');
                return `${m}:${s}.${ms}`;
            },
            
            render(ms) {
                const display = document.getElementById('timerDisplay');
                if (display) {
                    display.textContent = this.formatTime(ms);
                }
            },
            
            toggle() {
                const btn = document.getElementById('timerStartBtn');
                if (!btn) return;
                
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–∞–π–º–µ—Ä–∞
                
                if (this.running) {
                    this.stop();
                    btn.textContent = "–°—Ç–∞—Ä—Ç";
                    btn.classList.remove('active');
                } else {
                    this.start();
                    btn.textContent = "–°—Ç–æ–ø";
                    btn.classList.add('active');
                }
            },
            
            start() {
                this.running = true;
                this.startTime = Date.now();
                this.interval = setInterval(() => {
                    const delta = Date.now() - this.startTime;
                    this.render(this.accumulated + delta);
                }, 100); // 100ms –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            },
            
            stop() {
                this.running = false;
                this.accumulated += Date.now() - this.startTime;
                clearInterval(this.interval);
            },
            
            reset() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
                this.stop();
                this.accumulated = 0;
                this.render(0);
                const btn = document.getElementById('timerStartBtn');
                if (btn) {
                    btn.textContent = "–°—Ç–∞—Ä—Ç";
                    btn.classList.remove('active');
                }
            }
        };

        // ==================== APP STATE & LOGIC ====================
        const App = {
            state: {
                screen: 'groups',
                group: null,
                exercise: null,
                sets: [], // –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                activeExercises: [], // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å—É–ø–µ—Ä—Å–µ—Ç–æ–≤: [{name: "...", sets: [...]}]
                sessionId: null, // UUID —Å–µ—Å—Å–∏–∏ –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ —Å—É–ø–µ—Ä—Å–µ—Ç
                orderCounter: 0, // –°—á–µ—Ç—á–∏–∫ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–æ–≤
                isSaving: false // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–∞—Ö
            },

            init() {
                // Event Listeners
                document.getElementById('btnBack').onclick = () => App.goBack();
                document.getElementById('btnHistory').onclick = () => App.loadHistory();
                document.getElementById('btnAddSet').onclick = () => App.addSetRow();
                document.getElementById('timerStartBtn').onclick = () => Timer.toggle();
                document.getElementById('timerResetBtn').onclick = () => Timer.reset();
                document.getElementById('closeHistoryBtn').onclick = () => UI.toggleModal('modalHistory', false);
                document.getElementById('closeInfoBtn').onclick = () => UI.toggleModal('infoModal', false);
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                document.getElementById('modalHistory').onclick = (e) => {
                    if (e.target.id === 'modalHistory') UI.toggleModal('modalHistory', false);
                };
                document.getElementById('infoModal').onclick = (e) => {
                    if (e.target.id === 'infoModal') UI.toggleModal('infoModal', false);
                };
                document.getElementById('modalAddExercise').onclick = (e) => {
                    if (e.target.id === 'modalAddExercise') UI.toggleModal('modalAddExercise', false);
                };

                // === –õ–û–ì–ò–ö–ê –°–ß–ï–¢–ß–ò–ö–ê –ò –°–ï–°–°–ò–ò ===
                const savedSession = localStorage.getItem('gym_session_id');
                const savedOrder = localStorage.getItem('gym_order_counter');
                const lastDate = localStorage.getItem('gym_last_date');
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "DD.MM.YYYY"
                const today = new Date().toLocaleDateString('ru-RU');

                if (lastDate !== today) {
                    // üî• –ù–û–í–´–ô –î–ï–ù–¨: –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—ë
                    console.log("–ù–æ–≤—ã–π –¥–µ–Ω—å - —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞");
                    this.state.orderCounter = 0;
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –Ω–∞ –¥–µ–Ω—å (—á—Ç–æ–±—ã —Å–≤—è–∑—ã–≤–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                    this.state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                    localStorage.setItem('gym_last_date', today);
                    localStorage.setItem('gym_session_id', this.state.sessionId);
                    localStorage.setItem('gym_order_counter', '0');
                } else {
                    // üî• –¢–û–¢ –ñ–ï –î–ï–ù–¨: –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                    this.state.orderCounter = parseInt(savedOrder) || 0;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Å–µ—Å—Å–∏–∏, –µ—Å–ª–∏ –æ–Ω –±—ã–ª (–∏–ª–∏ —Å–æ–∑–¥–∞–µ–º, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ—Ç)
                    this.state.sessionId = savedSession || ('session_' + Date.now());
                }

                this.loadGroups();
                
                // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –æ—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
                UI.updateNav('', false);
            },

            goBack() {
                if (this.state.exercise) {
                    this.state.exercise = null;
                    Timer.reset();
                    UI.showScreen('exercises');
                    UI.updateNav(this.state.group, true, false); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –Ω–∞ —ç–∫—Ä–∞–Ω–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                } else if (this.state.group) {
                    this.state.group = null;
                    UI.showScreen('groups');
                    UI.updateNav('', false); // –ü–µ—Ä–µ–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                }
            },

            async loadGroups() {
                const listEl = document.getElementById('groups-list');
                UI.renderLoading('groups-list');
                
                try {
                    console.log('[App] –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø –º—ã—à—Ü...');
                    const res = await API.getGroups();
                    
                    if (res.error) {
                        console.error('[App] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', res.message);
                        listEl.innerHTML = `<div class="error">
                            <div>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                            <div style="font-size: 12px; margin-top: 8px; color: #888;">${res.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É'}</div>
                            <button onclick="App.loadGroups()" style="margin-top: 12px; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                        </div>`;
                return;
                    }
                    
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    const groups = fixDoubleSerialization(res.groups);
                    
                    if (groups && Array.isArray(groups) && groups.length > 0) {
                        console.log(`[App] –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥—Ä—É–ø–ø: ${groups.length}`);
                        UI.renderGroups(groups);
                    } else {
                        console.warn('[App] –ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                        listEl.innerHTML = '<div class="error">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    }
                } catch (e) {
                    console.error('[App] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', e);
                    listEl.innerHTML = `<div class="error">
                        <div>‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #888;">${e.message}</div>
                    </div>`;
                }
            },

            async selectGroup(group) {
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≥—Ä—É–ø–ø—ã
                this.state.group = group;
                UI.showScreen('exercises');
                UI.updateNav(group, true, false);
                
                const list = document.getElementById('exercises-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                const res = await API.getExercises(group);
                if (res.exercises) {
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    const exercises = fixDoubleSerialization(res.exercises);
                    UI.renderExercises(exercises);
                } else {
                    list.innerHTML = '<div class="error">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
                }
            },

            async loadAllExercises(isSearchMode = false) {
                if (!isSearchMode) {
                    Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–í—Å–µ"
                    this.state.group = '–í—Å–µ';
                    UI.showScreen('exercises');
                    UI.updateNav('–í—Å–µ', true, false);
                }
                
                const list = isSearchMode ? document.getElementById('groups-list') : document.getElementById('exercises-list');
                if (!isSearchMode) {
                    list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>';
            }
            
            try {
                    const groupsRes = await API.getGroups();
                    if (!groupsRes.groups || groupsRes.groups.length === 0) {
                        list.innerHTML = '<div class="error">–ù–µ—Ç –≥—Ä—É–ø–ø</div>';
                        return;
                    }
                    
                    const allExercises = [];
                    for (const group of groupsRes.groups) {
                        try {
                            const res = await API.getExercises(group);
                            if (res.exercises) {
                                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                                const exercises = fixDoubleSerialization(res.exercises);
                                allExercises.push(...exercises);
                            }
                        } catch (e) {
                            console.error(`–û—à–∏–±–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã ${group}:`, e);
                        }
                    }
                    
                    // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
                    const uniqueMap = new Map();
                    allExercises.forEach(ex => {
                        const name = typeof ex === 'string' ? ex : ex.name;
                        if (!uniqueMap.has(name)) {
                            uniqueMap.set(name, typeof ex === 'object' ? ex : {name: ex, desc: '', image: ''});
                        }
                    });
                    
                    const unique = Array.from(uniqueMap.values());
                    unique.sort((a, b) => {
                        const nameA = typeof a === 'string' ? a : a.name;
                        const nameB = typeof b === 'string' ? b : b.name;
                        return nameA.localeCompare(nameB, 'ru');
                    });
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    App.allExercisesCache = unique;
                    
                    if (isSearchMode) {
                        // –ï—Å–ª–∏ –≤—ã–∑–≤–∞–ª–∏ –∏–∑ –ø–æ–∏—Å–∫–∞, —Å—Ä–∞–∑—É —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–µ–∫—É—â–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é –∏–Ω–ø—É—Ç–∞
                        const query = document.getElementById('searchGroups').value;
                        UI.filterGlobal(query);
                    } else {
                        if (unique.length > 0) UI.renderExercises(unique);
                        else list.innerHTML = '<div class="error">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', e);
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';
                }
            },

            async selectExercise(ex) {
                Haptic.selection(); // üì≥ –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseObj = typeof ex === 'object' ? ex : {name: exerciseName, desc: '', image: ''};
                
                // ‚ùå –£–î–ê–õ–Ø–ï–ú –ì–ï–ù–ï–†–ê–¶–ò–Æ –ù–û–í–û–ô –°–ï–°–°–ò–ò (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É, —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∞ –≤ init –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å)
                // ‚ùå –£–î–ê–õ–Ø–ï–ú –°–ë–†–û–° –°–ß–ï–¢–ß–ò–ö–ê (—á—Ç–æ–±—ã –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–ª—Å—è: 5, 6, 7...)
                
                // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ sessionId –Ω–µ—Ç (–±–∞–≥), —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä–∞—Ö–æ–≤–∫—É
                if (!this.state.sessionId) {
                    this.state.sessionId = 'session_' + Date.now();
                }
                
                this.state.exercise = exerciseObj;
                UI.showScreen('workout');
                UI.updateNav(exerciseName, true, true);
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const res = await API.getHistory(exerciseName, 'last');
                
                // –†–∞–Ω—å—à–µ res.sets –±—ã–ª –º–∞—Å—Å–∏–≤–æ–º, —Ç–µ–ø–µ—Ä—å res –º–æ–∂–µ—Ç –±—ã—Ç—å {sets: [], note: ''}
                const historySets = res.sets || [];
                const lastNote = res.note || "";
                
                const initialSets = (historySets.length) 
                    ? historySets.map((s, idx) => {
                        let rest = s.rest || 0;
                        if (rest > 100) rest = rest / 60.0; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–Ω—É—Ç—ã
                        return {
                            ...s, 
                            rest, 
                            completed: false, 
                            id: Date.now() + idx + Math.random(),
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                            prevWeight: parseFloat(s.weight) || 0,
                            prevReps: parseInt(s.reps) || 0
                        };
                    })
                    : [{weight: 0, reps: 0, rest: 0, completed: false, id: Date.now(), prevWeight: 0, prevReps: 0}];
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º activeExercises —Å –ø–µ—Ä–≤—ã–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ–º
                this.state.activeExercises = [{
                    name: exerciseName,
                    exerciseObj: exerciseObj,
                    sets: initialSets,
                    note: lastNote  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–º–µ—Ç–∫—É –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                }];
                
                // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                this.state.sets = initialSets;
                
                UI.renderWorkoutScreen();
            },

            addSetRow() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥–∞
                const last = this.state.sets[this.state.sets.length - 1] || {weight: 0, reps: 0, rest: 0};
                this.state.sets.push({ ...last, completed: false, id: Date.now() + Math.random() });
                UI.renderSets(this.state.sets);
            },

            updateSetData(id, field, value) {
                const set = this.state.sets.find(s => s.id === id);
                if (set && !set.completed) {
                    const normalized = String(value).replace(',', '.');
                    if (field === 'reps') {
                        set[field] = parseInt(normalized) || 0;
        } else {
                        set[field] = parseFloat(normalized) || 0;
                    }
                }
            },

            async toggleSet(id) {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–∞—Ö
                if (this.state.isSaving) return;
                
                const idx = this.state.sets.findIndex(s => s.id === id);
                if (idx === -1) return;
                
                const set = this.state.sets[idx];
                if (set.completed) return;
                
                if (!set.weight || !set.reps) {
                    Haptic.notification('error'); // üì≥ –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã');
                    document.querySelector(`[data-id="${id}"] .set-checkbox`).checked = false;
                    return;
                }

                set.completed = true;
                UI.renderSets(this.state.sets);

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                this.state.orderCounter++;
                localStorage.setItem('gym_order_counter', this.state.orderCounter.toString());

                this.state.isSaving = true;
                try {
                    const res = await API.saveSet({
                        exercise: this.state.exercise.name,
                        weight: set.weight,
                        reps: set.reps,
                        rest: set.rest,
                        order: this.state.orderCounter, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
                        note: (this.state.activeExercises[0] && this.state.activeExercises[0].note) || ""  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–º–µ—Ç–∫—É –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                    });

                    if (res.status !== 'success') {
                        Haptic.notification('error'); // üì≥ –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
                        set.completed = false;
                        UI.renderSets(this.state.sets);
            } else {
                        Haptic.impact('medium'); // üì≥ –ü—Ä–∏—è—Ç–Ω—ã–π –ª–µ–≥–∫–∏–π —Å—Ç—É–∫ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                    }
                } catch (e) {
                    console.error('[App] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
                    Haptic.notification('error');
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
                    set.completed = false;
                    UI.renderSets(this.state.sets);
                } finally {
                    this.state.isSaving = false;
                }
            },

            removeSet(id) {
                const idx = this.state.sets.findIndex(s => s.id === id);
                if (idx !== -1 && !this.state.sets[idx].completed) {
                    this.state.sets.splice(idx, 1);
                    UI.renderSets(this.state.sets);
                }
            },

            // ==================== SUPERSET FUNCTIONS ====================
            
            updateNote(exIndex, value) {
                if (this.state.activeExercises[exIndex]) {
                    this.state.activeExercises[exIndex].note = value;
                }
            },
            
            async toggleSetInSuperset(exIndex, setIndex) {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–∞—Ö
                if (this.state.isSaving) return;
                
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (set.completed) return;
                
                if (!set.weight || !set.reps) {
                    Haptic.notification('error');
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã');
                    const checkbox = document.querySelector(`[data-ex-index="${exIndex}"][data-set-id="${set.id}"] .set-checkbox`);
                    if (checkbox) checkbox.checked = false;
                    return;
                }

                set.completed = true;
                UI.renderWorkoutScreen();

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                this.state.orderCounter++;
                localStorage.setItem('gym_order_counter', this.state.orderCounter.toString());

                this.state.isSaving = true;
                try {
                    const res = await API.saveSet({
                        exercise: exBlock.name,
                        weight: set.weight,
                        reps: set.reps,
                        rest: set.rest,
                        order: this.state.orderCounter, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
                        note: exBlock.note || ""  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–º–µ—Ç–∫—É
                    });

                    if (res.status !== 'success') {
                        Haptic.notification('error');
                        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
                        set.completed = false;
                        UI.renderWorkoutScreen();
                    } else {
                        Haptic.impact('medium');
                    }
                } catch (e) {
                    console.error('[App] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
                    Haptic.notification('error');
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
                    set.completed = false;
                    UI.renderWorkoutScreen();
                } finally {
                    this.state.isSaving = false;
                }
            },

            updateSetDataInSuperset(exIndex, setIndex, field, value) {
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (set && !set.completed) {
                    const normalized = String(value).replace(',', '.');
                    if (field === 'reps') {
                        set[field] = parseInt(normalized) || 0;
                    } else {
                        set[field] = parseFloat(normalized) || 0;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (DOM-–º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è)
                    const setId = set.id;
                    
                    // 1. –û–±–Ω–æ–≤–ª—è–µ–º 1–ü–ú
                    const ormEl = document.getElementById(`orm-${setId}`);
                    if (ormEl) {
                        const oneRM = UI.calculate1RM(set.weight, set.reps);
                        ormEl.textContent = oneRM > 0 ? `üèÜ 1–ü–ú: ${oneRM}–∫–≥` : '';
                    }
                    
                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –î–µ–ª—å—Ç—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–µ–Ω—è–µ–º –≤–µ—Å)
                    if (field === 'weight') {
                        const deltaEl = document.getElementById(`delta-${setId}`);
                        if (deltaEl) {
                            const deltaObj = UI.getDelta(set.weight, set.prevWeight);
                            if (deltaObj) {
                                deltaEl.textContent = deltaObj.text;
                                deltaEl.className = `stat-delta visible ${deltaObj.class}`;
                    } else {
                                deltaEl.className = 'stat-delta'; // –°–∫—Ä—ã–≤–∞–µ–º
                            }
                        }
                    }
                }
            },

            removeSetInSuperset(exIndex, setIndex) {
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock || !exBlock.sets[setIndex]) return;
                
                const set = exBlock.sets[setIndex];
                if (!set.completed) {
                    exBlock.sets.splice(setIndex, 1);
                    UI.renderWorkoutScreen();
                }
            },

            addSetToExercise(exIndex) {
                Haptic.impact('light');
                const exBlock = this.state.activeExercises[exIndex];
                if (!exBlock) return;
                
                const last = exBlock.sets[exBlock.sets.length - 1] || {weight: 0, reps: 0, rest: 0};
                exBlock.sets.push({ ...last, completed: false, id: Date.now() + Math.random() });
                UI.renderWorkoutScreen();
            },

            removeExerciseFromSuperset(exIndex) {
                if (exIndex === 0) return; // –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
                Haptic.impact('light');
                this.state.activeExercises.splice(exIndex, 1);
                UI.renderWorkoutScreen();
            },

            async showAddExerciseModal() {
                Haptic.impact('light');
                UI.toggleModal('modalAddExercise', true);
                const list = document.getElementById('add-exercise-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</div>';
                
                try {
                    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã –º—ã—à—Ü (—ç—Ç–æ –±—ã—Å—Ç—Ä–æ)
                    const res = await API.getGroups();
                    
                    if (!res.groups || res.groups.length === 0) {
                        list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                        return;
                    }

                    // 2. –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã
                    // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –≥—Ä—É–ø–ø—É –º—ã –±—É–¥–µ–º –∑–∞–≥—Ä—É–∂–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –í –≠–¢–û –ñ–ï –û–ö–ù–û
                    list.innerHTML = res.groups.map(group => `
                        <div class="list-item" onclick="App.loadExercisesForModal('${group}')">
                            <div style="flex-grow:1; font-weight:600;">${group}</div>
                            <div style="color:#667eea">‚Ä∫</div>
                        </div>
                    `).join('');
                    
                } catch (e) {
                    console.error(e);
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
                }
            },

            // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤–Ω—É—Ç—Ä—å –º–æ–¥–∞–ª–∫–∏
            async loadExercisesForModal(group) {
                const list = document.getElementById('add-exercise-list');
                list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</div>';
                
                try {
                    const res = await API.getExercises(group);
                    
                    if (!res.exercises) {
                        list.innerHTML = '<div class="error">–ü—É—Å—Ç–æ</div>';
                        return;
                    }
                    
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    const exercises = fixDoubleSerialization(res.exercises);
                    
                    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–∞–º" —Å–≤–µ—Ä—Ö—É
                    const backBtn = `
                        <div class="list-item" style="background:#f0f2f5; margin-bottom:10px;" onclick="App.showAddExerciseModal()">
                            <div style="font-weight:bold; color:#666">‚Üê –ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–∞–º</div>
                        </div>
                    `;
                    
                    const exercisesHtml = exercises.map(ex => {
                        const name = typeof ex === 'string' ? ex : ex.name;
                        // –§–∏–ª—å—Ç—Ä—É–µ–º, –µ—Å–ª–∏ —Ç–∞–∫–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ —Å—É–ø–µ—Ä—Å–µ—Ç–µ
                        const isAdded = App.state.activeExercises.some(active => active.name === name);
                        
                        if (isAdded) return ''; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
                        
                        return `
                            <div class="list-item" onclick='App.addExerciseToSuperset(${JSON.stringify(ex)})'>
                                <div style="flex-grow:1">${name}</div>
                                <div style="color:#28a745; font-weight:bold;">+</div>
                            </div>
                        `;
                    }).join('');
                    
                    list.innerHTML = backBtn + (exercisesHtml || '<div style="padding:15px; text-align:center">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>');
                    
                } catch (e) {
                    list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞</div>';
                }
            },

            async addExerciseToSuperset(ex) {
                Haptic.selection();
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseObj = typeof ex === 'object' ? ex : {name: exerciseName, desc: '', image: ''};
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const res = await API.getHistory(exerciseName, 'last');
                const historySets = res.sets || [];
                const lastNote = res.note || "";
                
                const initialSets = (historySets.length) 
                    ? historySets.map((s, idx) => {
                        let rest = s.rest || 0;
                        if (rest > 100) rest = rest / 60.0;
                        return {
                            ...s, 
                            rest, 
                            completed: false, 
                            id: Date.now() + idx + Math.random(),
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                            prevWeight: parseFloat(s.weight) || 0,
                            prevReps: parseInt(s.reps) || 0
                        };
                    })
                    : [{weight: 0, reps: 0, rest: 0, completed: false, id: Date.now(), prevWeight: 0, prevReps: 0}];
                
                // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Å—É–ø–µ—Ä—Å–µ—Ç
                App.state.activeExercises.push({
                    name: exerciseName,
                    exerciseObj: exerciseObj,
                    sets: initialSets,
                    note: lastNote  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–º–µ—Ç–∫—É –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                });
                
                UI.toggleModal('modalAddExercise', false);
                UI.renderWorkoutScreen();
            },

            async loadHistory() {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏
                UI.toggleModal('modalHistory', true);
                const cont = document.getElementById('history-content');
                cont.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                
                // –ë–µ—Ä–µ–º –∏–º—è –ø–µ—Ä–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                const exerciseName = App.state.activeExercises.length > 0 
                    ? App.state.activeExercises[0].name 
                    : (App.state.exercise ? App.state.exercise.name : '');
                
                if (!exerciseName) {
                    cont.innerHTML = "–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ";
                return;
            }
            
                const res = await API.getHistory(exerciseName);
                if (res.history) UI.renderHistory(res.history);
                else cont.innerHTML = "–ü—É—Å—Ç–æ";
            }
        };

        // ==================== UI RENDERER ====================
        const UI = {
            showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${id}`).classList.add('active');
                App.state.screen = id;
            },

            updateNav(title, back = false, history = false) {
                // –ï—Å–ª–∏ title –ø—É—Å—Ç–æ–π –∏–ª–∏ 'GymApp', –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const navTitle = document.getElementById('navbarTitle');
                if (!title || title === 'GymApp' || title.trim() === '') {
                    navTitle.textContent = '';
                } else {
                    navTitle.textContent = title;
                }
                document.getElementById('btnBack').classList.toggle('hidden', !back);
                document.getElementById('btnHistory').classList.toggle('hidden', !history);
            },

            toggleModal(id, show) {
                const modal = document.getElementById(id);
                if (id === 'infoModal') {
                    modal.classList.toggle('open', show);
                } else {
                    modal.classList.toggle('active', show);
                }
            },

            renderLoading(id) {
                document.getElementById(id).innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            },

            // –ú–∞–ø–ø–∏–Ω–≥ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –¥–ª—è –≥—Ä—É–ø–ø
            getGroupImage(groupName) {
                const map = {
                    '–ì—Ä—É–¥—å': 'img/chest.png', 
                    '–°–ø–∏–Ω–∞': 'img/back.png',
                    '–ù–æ–≥–∏': 'img/legs.png',
                    '–ü–ª–µ—á–∏': 'img/shoulders.png',
                    '–†—É–∫–∏': 'img/arms.png',
                    '–ë–∏—Ü–µ–ø—Å': 'img/biceps.png',
                    '–¢—Ä–∏—Ü–µ–ø—Å': 'img/triceps.png',
                    '–ö–∞—Ä–¥–∏–æ': 'img/cardio.png',
                    '–ü—Ä–µ—Å—Å': 'img/abs.png'
                };
                return map[groupName] || null;
            },

            renderGroups(groups) {
                const container = document.getElementById('groups-list');
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                const order = ['–°–ø–∏–Ω–∞', '–ù–æ–≥–∏', '–ì—Ä—É–¥—å', '–ü–ª–µ—á–∏', '–ë–∏—Ü–µ–ø—Å', '–¢—Ä–∏—Ü–µ–ø—Å', '–ö–∞—Ä–¥–∏–æ', '–ü—Ä–µ—Å—Å'];
                const sortedGroups = order.filter(g => groups.includes(g))
                    .concat(groups.filter(g => !order.includes(g)));
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∫ —Å–ø–∏—Å–æ–∫ (–∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ)
                const html = sortedGroups.map(group => {
                    const imgSrc = this.getGroupImage(group);
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞ - —Å—Ç–∞–≤–∏–º img, –∏–Ω–∞—á–µ –∑–∞–≥–ª—É—à–∫—É (–ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞)
                    const imgBlock = imgSrc 
                        ? `<img src="${imgSrc}" class="list-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="list-img placeholder" style="display:none;">${group[0]}</div>`
                        : `<div class="list-img placeholder">${group[0]}</div>`;

                    return `
                        <div class="list-item" onclick="App.selectGroup('${group.replace(/'/g, "\\'")}')">
                            ${imgBlock}
                            <div class="list-content">
                                <span class="list-title">${group}</span>
                                <span class="list-arrow">‚Ä∫</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="list-container">${html}</div><div class="groups-footer"><button class="btn-all" onclick="App.loadAllExercises()">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button></div>`;
            },

            renderExercises(list) {
                const container = document.getElementById('exercises-list');
                
                if (!list || list.length === 0) {
                    container.innerHTML = '<div class="loading">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }
                
                const html = list.map(ex => {
                    const name = typeof ex === 'string' ? ex : ex.name;
                    const image = (typeof ex === 'object' && ex.image) ? ex.image : null;
                    
                    // –ë–ª–æ–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π -> –ò–Ω—Ñ–æ)
                    const imgBlock = image 
                        ? `<img src="${image}" class="list-img" onclick='event.stopPropagation(); UI.showInfo(${JSON.stringify(ex)})'>`
                        : `<div class="list-img placeholder" onclick='event.stopPropagation(); UI.showInfo(${JSON.stringify(ex)})'>‚ÑπÔ∏è</div>`;

                    return `
                        <div class="list-item exercise-item" data-name="${name.toLowerCase()}">
                            ${imgBlock}
                            <div class="list-content" onclick='App.selectExercise(${JSON.stringify(ex)})'>
                                <span class="list-title">${name}</span>
                                <span class="list-arrow">‚Ä∫</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            },

            // –õ–æ–≥–∏–∫–∞ –ü–æ–∏—Å–∫–∞ (–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –ª–µ—Ç—É)
            filterExercises(query) {
                const q = query.toLowerCase();
                const items = document.querySelectorAll('.exercise-item');
                
                items.forEach(item => {
                    const name = item.getAttribute('data-name');
                    if (name.includes(q)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            },
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π (–ø–æ–∏—Å–∫ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º, –Ω–µ –ø–æ –≥—Ä—É–ø–ø–∞–º)
            filterGlobal(query) {
                const q = query.toLowerCase().trim();
                const list = document.getElementById('groups-list');
                
                if (q.length === 0) {
                    // –ï—Å–ª–∏ –ø—É—Å—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã
                    App.loadGroups(); 
                    return;
                }
                
                // –ï—Å–ª–∏ –Ω–∞—á–∞–ª–∏ –≤–≤–æ–¥–∏—Ç—å - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ "–ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º"
                if (!App.allExercisesCache || App.allExercisesCache.length === 0) {
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤—Å–µ–≥–æ (–ø–æ–∫–∞–∂–µ–º –ª–æ–∞–¥–µ—Ä)
                    list.innerHTML = '<div class="loading">–ò—â—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è...</div>';
                    App.loadAllExercises(true).then(() => {
                        // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
                        if (query.toLowerCase().trim() === q) {
                            UI.filterGlobal(query);
                        }
                    });
                        return;
                    }
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –∫—ç—à —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                const filtered = App.allExercisesCache.filter(ex => {
                    const name = typeof ex === 'string' ? ex : ex.name;
                    return name.toLowerCase().includes(q);
                });
                
                // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                if (filtered.length === 0) {
                    list.innerHTML = '<div class="loading">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∫ —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø—Ä—è–º–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≥—Ä—É–ø–ø
                const html = filtered.map(ex => {
                    const name = typeof ex === 'string' ? ex : ex.name;
                    const image = (typeof ex === 'object' && ex.image) ? ex.image : null;
                    const imgBlock = image 
                        ? `<img src="${image}" class="list-img" onclick='event.stopPropagation(); UI.showInfo(${JSON.stringify(ex)})'>`
                        : `<div class="list-img placeholder" onclick='event.stopPropagation(); UI.showInfo(${JSON.stringify(ex)})'>‚ÑπÔ∏è</div>`;

                    return `
                        <div class="list-item" onclick='App.selectExercise(${JSON.stringify(ex)})'>
                            ${imgBlock}
                            <div class="list-content">
                                <span class="list-title">${name}</span>
                                <span class="list-arrow">‚Ä∫</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                list.innerHTML = html || '<div class="loading">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            },

            renderSets(sets) {
                // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                const container = document.getElementById('sets-container');
                container.innerHTML = sets.map((set, index) => {
                    const setId = set.id || (Date.now() + index);
                    const safeId = JSON.stringify(setId);
                    return `
                        <div class="set-row ${set.completed ? 'completed' : ''}" data-id="${setId}">
                            <input type="checkbox" class="set-checkbox" ${set.completed ? 'checked disabled' : ''} 
                                   onchange="App.toggleSet(${safeId})">
                            <div class="set-inputs-group">
                                <div class="set-input-wrapper">
                                    <div class="input-label">–í–µ—Å</div>
                                    <input type="text" inputmode="decimal" class="set-input" 
                                           value="${String(set.weight || 0).replace(',', '.')}" 
                                           oninput="const val = UI.validateFloatInput(this); App.updateSetData(${safeId}, 'weight', val)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0">
                                </div>
                                <div class="set-input-wrapper">
                                    <div class="input-label">–ü–æ–≤—Ç–æ—Ä—ã</div>
                                    <input type="text" inputmode="numeric" class="set-input" 
                                           value="${set.reps || 0}" 
                                           oninput="App.updateSetData(${safeId}, 'reps', this.value)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0">
                                </div>
                                <div class="set-input-wrapper">
                                    <div class="input-label">–û—Ç–¥—ã—Ö (–º–∏–Ω)</div>
                                    <input type="text" inputmode="decimal" class="set-input" 
                                           value="${set.rest || 0}" 
                                           oninput="const val = UI.validateFloatInput(this); App.updateSetData(${safeId}, 'rest', val)"
                                           onfocus="this.select()"
                                           ${set.completed ? 'disabled' : ''} placeholder="0" step="0.5">
                                </div>
                            </div>
                            <button class="set-remove ${set.completed ? 'hidden' : ''}" 
                                    onclick="App.removeSet(${safeId})">√ó</button>
                        </div>
                    `;
                }).join('');
            },

            renderWorkoutScreen() {
                const container = document.getElementById('sets-container');
                
                // –ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–µ—Ç (–±–∞–≥), –æ—á–∏—â–∞–µ–º
                if (!App.state.activeExercises || App.state.activeExercises.length === 0) {
                    container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è</div>';
                    return;
                }
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–æ—á–∫—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                const cardsHtml = App.state.activeExercises.map((exBlock, exIndex) => {
                    const exerciseName = exBlock.name;
                    const sets = exBlock.sets || [];
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –ø–æ–¥—Ö–æ–¥–æ–≤ (–∫–∞–∫ –±—ã–ª–æ, –Ω–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
                    const setsHtml = sets.map((set, setIndex) => {
                        const setId = set.id || (Date.now() + exIndex * 1000 + setIndex);
                        const safeId = JSON.stringify(setId); // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                        
                        // –°—á–∏—Ç–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                        const oneRM = UI.calculate1RM(set.weight, set.reps);
                        const deltaObj = UI.getDelta(set.weight, set.prevWeight);
                        
                        let deltaHtml = '';
                        if (deltaObj) {
                            deltaHtml = `<span class="stat-delta visible ${deltaObj.class}" id="delta-${setId}">${deltaObj.text}</span>`;
                        } else {
                            deltaHtml = `<span class="stat-delta" id="delta-${setId}"></span>`;
                        }

                        const ormHtml = `<span class="stat-1rm" id="orm-${setId}">${oneRM > 0 ? 'üèÜ 1–ü–ú: ' + oneRM + '–∫–≥' : ''}</span>`;
                        
                        return `
                            <div class="set-row ${set.completed ? 'completed' : ''}" data-ex-index="${exIndex}" data-set-id="${setId}">
                                <input type="checkbox" class="set-checkbox" ${set.completed ? 'checked disabled' : ''} 
                                       onchange="App.toggleSetInSuperset(${exIndex}, ${setIndex})">
                                
                                <div style="flex: 1; width: 100%;">
                                    <div class="set-inputs-group">
                                        <div class="set-input-wrapper">
                                            <div class="input-label">–í–µ—Å</div>
                                            <input type="text" inputmode="decimal" class="set-input" 
                                                   value="${String(set.weight || 0).replace(',', '.')}" 
                                                   oninput="const val = UI.validateFloatInput(this); App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'weight', val)"
                                                   onfocus="this.select()"
                                                   ${set.completed ? 'disabled' : ''} placeholder="0">
                                        </div>
                                        <div class="set-input-wrapper">
                                            <div class="input-label">–ü–æ–≤—Ç</div>
                                            <input type="tel" inputmode="numeric" class="set-input" 
                                                   value="${set.reps || 0}" 
                                                   oninput="App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'reps', this.value)"
                                                   onfocus="this.select()"
                                                   ${set.completed ? 'disabled' : ''} placeholder="0">
                                        </div>
                                        <div class="set-input-wrapper">
                                            <div class="input-label">–û—Ç–¥(–º)</div>
                                            <input type="text" inputmode="decimal" class="set-input" 
                                                   value="${set.rest || 0}" 
                                                   oninput="const val = UI.validateFloatInput(this); App.updateSetDataInSuperset(${exIndex}, ${setIndex}, 'rest', val)"
                                                   onfocus="this.select()"
                                                   ${set.completed ? 'disabled' : ''} placeholder="0" step="0.5">
                                        </div>
                                    </div>
                                    
                                    <div class="stats-row">
                                        ${ormHtml}
                                        ${deltaHtml}
                                    </div>
                                </div>
                                
                                <button class="set-remove ${set.completed ? 'hidden' : ''}" 
                                        onclick="App.removeSetInSuperset(${exIndex}, ${setIndex})">√ó</button>
                            </div>
                        `;
                    }).join('');
                    
                    // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                    const currentNote = exBlock.note || '';
                    
                    // HTML –∑–∞–º–µ—Ç–∫–∏
                    const noteHtml = `
                        <div class="note-wrapper">
                            <span class="note-icon">üìù</span>
                            <input type="text" class="note-input" 
                                placeholder="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–Ω–∞–ø—Ä. –°–∏–¥–µ–Ω—å–µ 4)" 
                                value="${currentNote.replace(/"/g, '&quot;')}"
                                oninput="App.updateNote(${exIndex}, this.value)">
                        </div>
                    `;
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ü–µ–ª–∏–∫–æ–º
                    return `
                        <div class="exercise-card">
                            <div class="exercise-header">
                                <span class="exercise-title">${exIndex + 1}. ${exerciseName}</span>
                                ${exIndex > 0 ? `<button class="btn-remove-exercise" onclick="App.removeExerciseFromSuperset(${exIndex})">√ó</button>` : ''}
                            </div>
                            
                            ${noteHtml}
                            
                            <div class="exercise-sets">
                                ${setsHtml}
                            </div>
                            
                            <button class="btn-add-set-small" onclick="App.addSetToExercise(${exIndex})">
                                + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥
                            </button>
                        </div>
                    `;
                }).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" –≤ —Å–∞–º–æ–º –Ω–∏–∑—É
                const addExerciseBtn = `
                    <button class="btn-add-exercise-global" onclick="App.showAddExerciseModal()">
                        <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Å–µ—Ç
                    </button>
                `;
                
                container.innerHTML = cardsHtml + addExerciseBtn;
            },

            renderHistory(historyData) {
                const container = document.getElementById('history-content');
                container.innerHTML = '';
                
                if (!historyData || historyData.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                        return;
                    }
                    
                // 1. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –î–ê–¢–ï
                const byDate = {};
                historyData.forEach(item => {
                    let dateKey = String(item.date || '').split(',')[0].trim();
                    if (!dateKey) return;
                    
                    if (!byDate[dateKey]) byDate[dateKey] = {};
                    
                    // 2. –í–Ω—É—Ç—Ä–∏ –¥–∞—Ç—ã –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ set_group_id
                    const groupId = item.set_group_id || 'unknown_' + Math.random();
                    if (!byDate[dateKey][groupId]) byDate[dateKey][groupId] = [];
                    byDate[dateKey][groupId].push(item);
                });
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞—Ç
                const sortedDates = Object.keys(byDate).sort((a, b) => {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 23.11.2025 –≤ 2025-11-23 –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    const toISO = (d) => d.split('.').reverse().join('-');
                    return toISO(b).localeCompare(toISO(a));
                });
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
                let fullHtml = '';
                
                sortedDates.forEach(date => {
                    fullHtml += `<div class="history-date-header">üìÖ ${date}</div>`;
                    
                    const groupsInDate = byDate[date];
                    Object.values(groupsInDate).forEach(groupItems => {
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å—É–ø–µ—Ä—Å–µ—Ç —ç—Ç–æ –∏–ª–∏ –æ–±—ã—á–Ω—ã–π —Å–µ—Ç
                        // (–µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–µ –µ—Å—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏)
                        const uniqueNames = [...new Set(groupItems.map(i => i.exercise))];
                        const isSuperset = uniqueNames.length > 1;
                        
                        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
                        let headerHtml = '';
                        if (isSuperset) {
                            headerHtml = `
                                <div class="history-superset-header">
                                    <span class="badge-superset">–°—É–ø–µ—Ä—Å–µ—Ç</span>
                                    <span>${uniqueNames.join(' + ')}</span>
                                </div>
                            `;
                        }
                        
                        // –°–ø–∏—Å–æ–∫ –ø–æ–¥—Ö–æ–¥–æ–≤
                        const rowsHtml = groupItems.map(item => {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Å—É–ø–µ—Ä—Å–µ—Ç
                            const nameBlock = isSuperset 
                                ? `<div class="history-ex-name">${item.exercise}</div>` 
                                : '';
                            
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–¥—ã—Ö
                            let restDisplay = '';
                            if (item.rest) {
                                let restMinutes = item.rest;
                                if (restMinutes > 100) restMinutes = restMinutes / 60.0;
                                if (restMinutes % 1 === 0) {
                                    restDisplay = `${restMinutes}–º`;
                                } else {
                                    restDisplay = `${restMinutes.toFixed(1)}–º`;
                                }
                            }
                                
                            return `
                                <div class="history-item-row">
                                    <div>
                                        ${nameBlock}
                                        <div class="history-ex-vals">
                                            ${item.weight} –∫–≥ √ó ${item.reps}
                                        </div>
                                    </div>
                                    <div style="color:#aaa; font-size:12px;">
                                        ${restDisplay}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        fullHtml += `
                            <div class="history-superset-card">
                                ${headerHtml}
                                ${rowsHtml}
                            </div>
                        `;
                    });
                });
                
                container.innerHTML = fullHtml;
            },

            showInfo(ex) {
                Haptic.impact('light'); // üì≥ –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                const exerciseName = typeof ex === 'string' ? ex : ex.name;
                const exerciseDesc = typeof ex === 'object' ? (ex.desc || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') : '';
                const exerciseImage = typeof ex === 'object' ? (ex.image || '') : '';
                
                document.getElementById('modalTitle').textContent = exerciseName;
                const descEl = document.getElementById('modalDesc');
                descEl.textContent = (exerciseDesc && exerciseDesc !== 'undefined' && exerciseDesc !== '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') 
                    ? exerciseDesc 
                    : '–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.';
                
                const imgEl = document.getElementById('modalImage');
                if (exerciseImage && exerciseImage !== 'undefined' && exerciseImage !== '') {
                    imgEl.src = exerciseImage;
                    imgEl.style.display = 'block';
                        } else {
                    imgEl.style.display = 'none';
                }
                
                this.toggleModal('infoModal', true);
            },

            // === –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –º–∏–∫—Ä–æ-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ ===
            calculate1RM(weight, reps) {
                const w = parseFloat(weight) || 0;
                const r = parseInt(reps) || 0;
                if (w === 0 || r === 0) return 0;
                if (r === 1) return w;
                // –§–æ—Ä–º—É–ª–∞ –≠–ø–ª–∏: Weight * (1 + Reps/30)
                return Math.round(w * (1 + r / 30));
            },

            getDelta(current, prev) {
                const curVal = parseFloat(current) || 0;
                const prevVal = parseFloat(prev) || 0;
                
                if (prevVal === 0) return null; // –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ - –Ω–µ—Ç –¥–µ–ª—å—Ç—ã
                
                const diff = curVal - prevVal;
                // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1 –∑–Ω–∞–∫–∞, –µ—Å–ª–∏ –¥—Ä–æ–±–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä 2.5), –∏–Ω–∞—á–µ —Ü–µ–ª–æ–µ
                const diffStr = Number.isInteger(diff) ? diff : diff.toFixed(1);
                
                if (diff > 0) return { text: `+${diffStr} –∫–≥`, class: 'positive' };
                if (diff < 0) return { text: `${diffStr} –∫–≥`, class: 'negative' };
                return { text: '0', class: 'neutral' };
            },

            validateFloatInput(input) {
                let val = input.value.replace(/[^0-9.,]/g, '');
                val = val.replace(',', '.');
                const parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join('');
                }
                if (input.value !== val) {
                    input.value = val;
                }
                return val;
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å HTML)
        function goBack() { App.goBack(); }
        function showHistory() { App.loadHistory(); }
        function closeHistory() { UI.toggleModal('modalHistory', false); }
        function openInfoModal(title, desc, image) { UI.showInfo({name: title, desc, image}); }
        function closeInfoModal(event) {
            if (event === null || event.target.id === 'infoModal') {
                UI.toggleModal('infoModal', false);
            }
        }
        function toggleTimer() { Timer.toggle(); }
        function resetTimer() { Timer.reset(); }
        function addSet() { App.addSetRow(); }

        // Start
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
